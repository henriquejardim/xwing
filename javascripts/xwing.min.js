(function(){var t,i,n,e,s,a,o=[].slice,l=[].indexOf||function(t){for(var i=0,n=this.length;n>i;i++)if(i in this&&this[i]===t)return i;return-1},r=function(t,i){return function(){return t.apply(i,arguments)}},d={}.hasOwnProperty,u=function(t,i){function n(){this.constructor=t}for(var e in i)d.call(i,e)&&(t[e]=i[e]);return n.prototype=i.prototype,t.prototype=new n,t.__super__=i.prototype,t};window.iced={Deferrals:function(){function t(t){this.continuation=t,this.count=1,this.ret=null}return t.prototype._fulfill=function(){return--this.count?void 0:this.continuation(this.ret)},t.prototype.defer=function(t){return++this.count,function(i){return function(){var n,e;return n=1<=arguments.length?o.call(arguments,0):[],null!=t&&null!=(e=t.assign_fn)&&e.apply(null,n),i._fulfill()}}(this)},t}(),findDeferral:function(){return null},trampoline:function(t){return t()}},window.__iced_k=window.__iced_k_noop=function(){},s="undefined"!=typeof exports&&null!==exports?exports:this,s.sortHelper=function(t,i){var n,e;return t.points===i.points?(n=t.text.replace(/[^a-z0-9]/gi,""),e=i.text.replace(/[^a-z0-9]/gi,""),n===e?0:n>e?1:-1):t.points>i.points?1:-1},$.isMobile=function(){return navigator.userAgent.match(/(iPhone|iPod|iPad|Android)/i)},$.randomInt=function(t){return Math.floor(Math.random()*t)},$.getParameterByName=function(t){var i,n,e;return t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),n="[\\?&]"+t+"=([^&#]*)",i=new RegExp(n),e=i.exec(window.location.search),null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))},Array.prototype.intersects=function(t){var i,n,e;for(n=0,e=this.length;e>n;n++)if(i=this[n],l.call(t,i)>=0)return!0;return!1},Array.prototype.removeItem=function(t){var i;return i=this.indexOf(t),-1!==i&&this.splice(i,1),this},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},n=24,a=function(t,i,n){return""+t+(i[n]!==t?" ("+i[n]+")":"")},s.SquadBuilder=function(){function i(t){this._makeRandomizerLoopFunc=r(this._makeRandomizerLoopFunc,this),this._randomizerLoopBody=r(this._randomizerLoopBody,this),this.releaseUnique=r(this.releaseUnique,this),this.claimUnique=r(this.claimUnique,this),this.onSquadNameChanged=r(this.onSquadNameChanged,this),this.onSquadDirtinessChanged=r(this.onSquadDirtinessChanged,this),this.onSquadLoadRequested=r(this.onSquadLoadRequested,this),this.onPointsUpdated=r(this.onPointsUpdated,this),this.onGameTypeChanged=r(this.onGameTypeChanged,this),this.onNotesUpdated=r(this.onNotesUpdated,this),this.container=$(t.container),this.faction=$.trim(t.faction),this.printable_container=$(t.printable_container),this.tab=$(t.tab),this.ships=[],this.uniques_in_use={Pilot:[],Upgrade:[],Modification:[],Title:[]},this.suppress_automatic_new_ship=!1,this.tooltip_currently_displaying=null,this.randomizer_options={sources:null,points:100},this.total_points=0,this.isCustom=!1,this.isEpic=!1,this.maxEpicPointsAllowed=0,this.maxSmallShipsOfOneType=null,this.maxLargeShipsOfOneType=null,this.backend=null,this.current_squad={},this.language="English",this.collection=null,this.setupUI(),this.setupEventHandlers(),this.resetCurrentSquad(),$.getParameterByName("f")===this.faction?this.loadFromSerialized($.getParameterByName("d")):this.addShip()}return i.prototype.resetCurrentSquad=function(){return this.current_squad={id:null,name:$.trim(this.squad_name_input.val())||"Unnamed Squadron",dirty:!1,additional_data:{points:this.total_points,description:"",cards:[],notes:""},faction:this.faction},this.total_points>0&&(this.current_squad.name="Unsaved Squadron",this.current_squad.dirty=!0),this.container.trigger("xwing-backend:squadNameChanged"),this.container.trigger("xwing-backend:squadDirtinessChanged")},i.prototype.newSquadFromScratch=function(){return this.squad_name_input.val("New Squadron"),this.removeAllShips(),this.addShip(),this.resetCurrentSquad(),this.notes.val("")},i.prototype.setupUI=function(){var t,i,n,e,a,o,l,r,d;for(i=100,n=2,t=1e3,this.status_container=$(document.createElement("DIV")),this.status_container.addClass("container-fluid"),this.status_container.append($.trim('<div class="row-fluid">\n    <div class="span3 squad-name-container">\n        <div class="display-name">\n            <span class="squad-name"></span>\n            <i class="icon-pencil"></i>\n        </div>\n        <div class="input-append">\n            <input type="text" maxlength="64" placeholder="Name your squad..." />\n            <button class="btn save"><i class="icon-edit"></i></button>\n        </div>\n    </div>\n    <div class="span4 points-display-container">\n        Points: <span class="total-points">0</span> / <input type="number" class="desired-points" value="100">\n        <select class="game-type-selector">\n            <option value="standard">Standard</option>\n            <option value="epic">Epic</option>\n            <option value="team-epic">Team Epic</option>\n            <option value="custom">Custom</option>\n        </select>\n        <span class="points-remaining-container">(<span class="points-remaining"></span>&nbsp;left)</span>\n        <span class="total-epic-points-container hidden"><br /><span class="total-epic-points">0</span> / <span class="max-epic-points">5</span> Epic Points</span>\n        <span class="content-warning unreleased-content-used hidden"><br /><i class="icon-exclamation-sign"></i>&nbsp;This squad uses unreleased content!</span>\n        <span class="content-warning epic-content-used hidden"><br /><i class="icon-exclamation-sign"></i>&nbsp;This squad uses Epic content!</span>\n        <span class="content-warning illegal-epic-upgrades hidden"><br /><i class="icon-exclamation-sign"></i>&nbsp;Navigator cannot be equipped onto Huge ships in Epic tournament play!</span>\n        <span class="content-warning illegal-epic-too-many-small-ships hidden"><br /><i class="icon-exclamation-sign"></i>&nbsp;You may not field more than 12 of the same type Small ship!</span>\n        <span class="content-warning illegal-epic-too-many-large-ships hidden"><br /><i class="icon-exclamation-sign"></i>&nbsp;You may not field more than 6 of the same type Large ship!</span>\n        <span class="content-warning collection-invalid hidden"><br /><i class="icon-exclamation-sign"></i>&nbsp;You cannot field this list with your collection!</span>\n    </div>\n    <div class="span5 pull-right button-container">\n        <div class="btn-group pull-right">\n\n            <button class="btn btn-primary view-as-text"><span class="hidden-phone"><i class="icon-print"></i>&nbsp;Print/View as </span>Text</button>\n            <!-- <button class="btn btn-primary print-list hidden-phone hidden-tablet"><i class="icon-print"></i>&nbsp;Print</button> -->\n            <a class="btn btn-primary hidden collection"><i class="icon-folder-open hidden-phone hidden-tabler"></i>&nbsp;Your Collection</a>\n            <a class="btn btn-primary permalink"><i class="icon-link hidden-phone hidden-tablet"></i>&nbsp;Permalink</a>\n\n            <!--\n            <button class="btn btn-primary randomize" ><i class="icon-random hidden-phone hidden-tablet"></i>&nbsp;Random!</button>\n            <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">\n                <span class="caret"></span>\n            </button>\n            <ul class="dropdown-menu">\n                <li><a class="randomize-options">Randomizer Options...</a></li>\n            </ul>\n            -->\n\n        </div>\n    </div>\n</div>\n\n<div class="row-fluid style="display: none;">\n    <div class="span12">\n        <button class="show-authenticated btn btn-primary save-list"><i class="icon-save"></i>&nbsp;Save</button>\n        <button class="show-authenticated btn btn-primary save-list-as"><i class="icon-copy"></i>&nbsp;Save As...</button>\n        <button class="show-authenticated btn btn-primary delete-list disabled"><i class="icon-trash"></i>&nbsp;Delete</button>\n        <button class="show-authenticated btn btn-primary backend-list-my-squads show-authenticated">Load Squad</button>\n        <button class="btn btn-danger clear-squad">New Squad</button>\n        <span class="show-authenticated backend-status"></span>\n    </div>\n</div>')),this.container.append(this.status_container),this.list_modal=$(document.createElement("DIV")),this.list_modal.addClass("modal hide fade text-list-modal"),this.container.append(this.list_modal),this.list_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close hidden-print" data-dismiss="modal" aria-hidden="true">&times;</button>\n\n    <div class="hidden-phone hidden-print">\n        <div class="fancy-header">\n            <div class="squad-name"></div>\n            <div class="mask">\n                <div class="outer-circle">\n                    <div class="inner-circle">\n                        <span class="total-points"></span>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class="fancy-under-header"></div>\n    </div>\n\n    <div class="visible-print">\n        <div class="fancy-header">\n            <div class="squad-name"></div>\n            <div class="mask">\n                <div class="outer-circle">\n                    <div class="inner-circle">\n                        <span class="total-points"></span>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class="fancy-under-header"></div>\n    </div>\n\n    <div class="visible-phone hidden-print">\n        <h4><span class="squad-name"></span> (<span class="total-points"></span>)<h4>\n    </div>\n\n</div>\n<div class="modal-body">\n    <div class="fancy-list hidden-phone"></div>\n    <div class="simple-list"></div>\n    <div class="bbcode-list">\n        Copy the BBCode below and paste it into your forum post.\n        <textarea></textarea>\n    </div>\n</div>\n<div class="modal-footer hidden-print">\n    <label class="vertical-space-checkbox">\n        Add space for damage/upgrade cards when printing <input type="checkbox" class="toggle-vertical-space" />\n    </label>\n    <label class="color-print-checkbox">\n        Print color <input type="checkbox" class="toggle-color-print" />\n    </label>\n    <div class="btn-group list-display-mode">\n        <button class="btn select-simple-view">Simple</button>\n        <button class="btn select-fancy-view hidden-phone">Fancy</button>\n        <button class="btn select-bbcode-view">BBCode</button>\n    </div>\n    <button class="btn print-list hidden-phone"><i class="icon-print"></i>&nbsp;Print</button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.fancy_container=$(this.list_modal.find("div.modal-body .fancy-list")),this.fancy_total_points_container=$(this.list_modal.find("div.modal-header .total-points")),this.simple_container=$(this.list_modal.find("div.modal-body .simple-list")),this.bbcode_container=$(this.list_modal.find("div.modal-body .bbcode-list")),this.bbcode_textarea=$(this.bbcode_container.find("textarea")),this.bbcode_textarea.attr("readonly","readonly"),this.toggle_vertical_space_container=$(this.list_modal.find(".vertical-space-checkbox")),this.toggle_color_print_container=$(this.list_modal.find(".color-print-checkbox")),this.select_simple_view_button=$(this.list_modal.find(".select-simple-view")),this.select_simple_view_button.click(function(t){return function(){return t.select_simple_view_button.blur(),"simple"!==t.list_display_mode?(t.list_modal.find(".list-display-mode .btn").removeClass("btn-inverse"),t.select_simple_view_button.addClass("btn-inverse"),t.list_display_mode="simple",t.simple_container.show(),t.fancy_container.hide(),t.bbcode_container.hide(),t.toggle_vertical_space_container.hide(),t.toggle_color_print_container.hide()):void 0}}(this)),this.select_fancy_view_button=$(this.list_modal.find(".select-fancy-view")),this.select_fancy_view_button.click(function(t){return function(){return t.select_fancy_view_button.blur(),"fancy"!==t.list_display_mode?(t.list_modal.find(".list-display-mode .btn").removeClass("btn-inverse"),t.select_fancy_view_button.addClass("btn-inverse"),t.list_display_mode="fancy",t.fancy_container.show(),t.simple_container.hide(),t.bbcode_container.hide(),t.toggle_vertical_space_container.show(),t.toggle_color_print_container.show()):void 0}}(this)),this.select_bbcode_view_button=$(this.list_modal.find(".select-bbcode-view")),this.select_bbcode_view_button.click(function(t){return function(){return t.select_bbcode_view_button.blur(),"bbcode"!==t.list_display_mode?(t.list_modal.find(".list-display-mode .btn").removeClass("btn-inverse"),t.select_bbcode_view_button.addClass("btn-inverse"),t.list_display_mode="bbcode",t.bbcode_container.show(),t.simple_container.hide(),t.fancy_container.hide(),t.bbcode_textarea.select(),t.bbcode_textarea.focus(),t.toggle_vertical_space_container.show(),t.toggle_color_print_container.show()):void 0}}(this)),$(window).width()>=768?(this.simple_container.hide(),this.select_fancy_view_button.click()):this.select_simple_view_button.click(),this.clear_squad_button=$(this.status_container.find(".clear-squad")),this.clear_squad_button.click(function(t){return function(){return t.current_squad.dirty&&null!=t.backend?t.backend.warnUnsaved(t,function(){return t.newSquadFromScratch()}):t.newSquadFromScratch()}}(this)),this.squad_name_container=$(this.status_container.find("div.squad-name-container")),this.squad_name_display=$(this.container.find(".display-name")),this.squad_name_placeholder=$(this.container.find(".squad-name")),this.squad_name_input=$(this.squad_name_container.find("input")),this.squad_name_save_button=$(this.squad_name_container.find("button.save")),this.squad_name_input.closest("div").hide(),this.points_container=$(this.status_container.find("div.points-display-container")),this.total_points_span=$(this.points_container.find(".total-points")),this.game_type_selector=$(this.status_container.find(".game-type-selector")),this.game_type_selector.change(function(t){return function(){return t.onGameTypeChanged(t.game_type_selector.val())}}(this)),this.desired_points_input=$(this.points_container.find(".desired-points")),this.desired_points_input.change(function(t){return function(){return t.game_type_selector.val("custom"),t.onGameTypeChanged("custom")}}(this)),this.points_remaining_span=$(this.points_container.find(".points-remaining")),this.points_remaining_container=$(this.points_container.find(".points-remaining-container")),this.unreleased_content_used_container=$(this.points_container.find(".unreleased-content-used")),this.epic_content_used_container=$(this.points_container.find(".epic-content-used")),this.illegal_epic_upgrades_container=$(this.points_container.find(".illegal-epic-upgrades")),this.too_many_small_ships_container=$(this.points_container.find(".illegal-epic-too-many-small-ships")),this.too_many_large_ships_container=$(this.points_container.find(".illegal-epic-too-many-large-ships")),this.collection_invalid_container=$(this.points_container.find(".collection-invalid")),this.total_epic_points_container=$(this.points_container.find(".total-epic-points-container")),this.total_epic_points_span=$(this.total_epic_points_container.find(".total-epic-points")),this.max_epic_points_span=$(this.points_container.find(".max-epic-points")),this.permalink=$(this.status_container.find("div.button-container a.permalink")),this.view_list_button=$(this.status_container.find("div.button-container button.view-as-text")),this.randomize_button=$(this.status_container.find("div.button-container button.randomize")),this.customize_randomizer=$(this.status_container.find("div.button-container a.randomize-options")),this.backend_status=$(this.status_container.find(".backend-status")),this.backend_status.hide(),this.collection_button=$(this.status_container.find("div.button-container a.collection")),this.collection_button.click(function(t){return function(i){return i.preventDefault(),t.collection_button.prop("disabled")?void 0:t.collection.modal.modal("show")}}(this)),this.squad_name_input.keypress(function(t){return function(i){return 13===i.which?(t.squad_name_save_button.click(),!1):void 0}}(this)),this.squad_name_input.change(function(t){return function(){return t.backend_status.fadeOut("slow")}}(this)),this.squad_name_input.blur(function(t){return function(){return t.squad_name_input.change(),t.squad_name_save_button.click()}}(this)),this.squad_name_display.click(function(t){return function(i){return i.preventDefault(),t.squad_name_display.hide(),t.squad_name_input.val($.trim(t.current_squad.name)),window.setTimeout(function(){return t.squad_name_input.focus(),t.squad_name_input.select()},100),t.squad_name_input.closest("div").show()}}(this)),this.squad_name_save_button.click(function(t){return function(i){var n;return i.preventDefault(),t.current_squad.dirty=!0,t.container.trigger("xwing-backend:squadDirtinessChanged"),n=t.current_squad.name=$.trim(t.squad_name_input.val()),n.length>0?(t.squad_name_display.show(),t.container.trigger("xwing-backend:squadNameChanged"),t.squad_name_input.closest("div").hide()):void 0}}(this)),this.randomizer_options_modal=$(document.createElement("DIV")),this.randomizer_options_modal.addClass("modal hide fade"),$("body").append(this.randomizer_options_modal),this.randomizer_options_modal.append($.trim('<div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Random Squad Builder Options</h3>\n</div>\n<div class="modal-body">\n    <form>\n        <label>\n            Desired Points\n            <input type="number" class="randomizer-points" value="'+i+'" placeholder="'+i+'" />\n        </label>\n        <label>\n            Sets and Expansions (default all)\n            <select class="randomizer-sources" multiple="1" data-placeholder="Use all sets and expansions">\n            </select>\n        </label>\n        <label>\n            Maximum Seconds to Spend Randomizing\n            <input type="number" class="randomizer-timeout" value="'+n+'" placeholder="'+n+'" />\n        </label>\n        <label>\n            Maximum Randomization Iterations\n            <input type="number" class="randomizer-iterations" value="'+t+'" placeholder="'+t+'" />\n        </label>\n    </form>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary do-randomize" aria-hidden="true">Randomize!</button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>\n</div>')),this.randomizer_source_selector=$(this.randomizer_options_modal.find("select.randomizer-sources")),d=s.expansions,l=0,r=d.length;r>l;l++)a=d[l],o=$(document.createElement("OPTION")),o.text(a),this.randomizer_source_selector.append(o);return this.randomizer_source_selector.select2({width:"100%",minimumResultsForSearch:$.isMobile()?-1:0}),this.randomize_button.click(function(e){return function(s){var a,o,l;return s.preventDefault(),e.current_squad.dirty&&null!=e.backend?e.backend.warnUnsaved(e,function(){return e.randomize_button.click()}):(o=parseInt($(e.randomizer_options_modal.find(".randomizer-points")).val()),(isNaN(o)||0>=o)&&(o=i),l=parseInt($(e.randomizer_options_modal.find(".randomizer-timeout")).val()),(isNaN(l)||0>=l)&&(l=n),a=parseInt($(e.randomizer_options_modal.find(".randomizer-iterations")).val()),(isNaN(a)||0>=a)&&(a=t),e.randomSquad(o,e.randomizer_source_selector.val(),1e3*n,a))}}(this)),this.randomizer_options_modal.find("button.do-randomize").click(function(t){return function(i){return i.preventDefault(),t.randomizer_options_modal.modal("hide"),t.randomize_button.click()}}(this)),this.customize_randomizer.click(function(t){return function(i){return i.preventDefault(),t.randomizer_options_modal.modal()}}(this)),this.backend_list_squads_button=$(this.container.find("button.backend-list-my-squads")),this.backend_list_squads_button.click(function(t){return function(i){return i.preventDefault(),null!=t.backend?t.backend.list(t):void 0}}(this)),this.backend_save_list_button=$(this.container.find("button.save-list")),this.backend_save_list_button.click(function(t){return function(i){var n,e,s,a,o;return o=__iced_k_noop,s=iced.findDeferral(arguments),i.preventDefault(),null==t.backend||t.backend_save_list_button.hasClass("disabled")?o():(n={points:t.total_points,description:t.describeSquad(),cards:t.listCards(),notes:t.notes.val().substr(0,1024)},t.backend_status.html($.trim('<i class="icon-refresh icon-spin"></i>&nbsp;Saving squad...')),t.backend_status.show(),t.backend_save_list_button.addClass("disabled"),function(i){a=new iced.Deferrals(i,{parent:s,filename:"coffeescripts/xwing.coffee"}),t.backend.save(t.serialize(),t.current_squad.id,t.current_squad.name,t.faction,n,a.defer({assign_fn:function(){return function(){return e=arguments[0]}}(),lineno:490})),a._fulfill()}(function(){return o(e.success?(t.current_squad.dirty=!1,null!=t.current_squad.id?t.backend_status.html($.trim('<i class="icon-ok"></i>&nbsp;Squad updated successfully.')):(t.backend_status.html($.trim('<i class="icon-ok"></i>&nbsp;New squad saved successfully.')),t.current_squad.id=e.id),t.container.trigger("xwing-backend:squadDirtinessChanged")):(t.backend_status.html($.trim('<i class="icon-exclamation-sign"></i>&nbsp;'+e.error)),t.backend_save_list_button.removeClass("disabled")))}),void 0)}}(this)),this.backend_save_list_as_button=$(this.container.find("button.save-list-as")),this.backend_save_list_as_button.addClass("disabled"),this.backend_save_list_as_button.click(function(t){return function(i){return i.preventDefault(),null==t.backend||t.backend_save_list_as_button.hasClass("disabled")?void 0:t.backend.showSaveAsModal(t)}}(this)),this.backend_delete_list_button=$(this.container.find("button.delete-list")),this.backend_delete_list_button.click(function(t){return function(i){return i.preventDefault(),null==t.backend||t.backend_delete_list_button.hasClass("disabled")?void 0:t.backend.showDeleteModal(t)}}(this)),e=$(document.createElement("DIV")),e.addClass("container-fluid"),this.container.append(e),e.append($.trim('<div class="row-fluid">\n    <div class="span9 ship-container">\n                <label class="notes-container show-authenticated">\n                    Squad Notes:\n                    <br />\n                    <textarea class="squad-notes"></textarea>\n                </label>\n    </div>\n    <div class="span3 info-container" />\n</div>')),this.ship_container=$(e.find("div.ship-container")),this.info_container=$(e.find("div.info-container")),this.notes_container=$(e.find(".notes-container")),this.notes=$(this.notes_container.find("textarea.squad-notes")),this.info_container.append($.trim('<div class="well well-small info-well">\n    <span class="info-name"></span>\n    <br />\n    <span class="info-sources"></span>\n    <table>\n        <tbody>\n            <tr class="info-ship">\n                <td class="info-header">Ship</td>\n                <td class="info-data"></td>\n            </tr>\n            <tr class="info-skill">\n                <td class="info-header">Skill</td>\n                <td class="info-data info-skill"></td>\n            </tr>\n            <tr class="info-energy">\n                <td class="info-header"><i class="xwing-miniatures-font xwing-miniatures-font-energy"></i></td>\n                <td class="info-data info-energy"></td>\n            </tr>\n            <tr class="info-attack">\n                <td class="info-header"><i class="xwing-miniatures-font xwing-miniatures-font-attack"></i></td>\n                <td class="info-data info-attack"></td>\n            </tr>\n            <tr class="info-range">\n                <td class="info-header">Range</td>\n                <td class="info-data info-range"></td>\n            </tr>\n            <tr class="info-agility">\n                <td class="info-header"><i class="xwing-miniatures-font xwing-miniatures-font-agility"></i></td>\n                <td class="info-data info-agility"></td>\n            </tr>\n            <tr class="info-hull">\n                <td class="info-header"><i class="xwing-miniatures-font xwing-miniatures-font-hull"></i></td>\n                <td class="info-data info-hull"></td>\n            </tr>\n            <tr class="info-shields">\n                <td class="info-header"><i class="xwing-miniatures-font xwing-miniatures-font-shield"></i></td>\n                <td class="info-data info-shields"></td>\n            </tr>\n            <tr class="info-actions">\n                <td class="info-header">Actions</td>\n                <td class="info-data"></td>\n            </tr>\n            <tr class="info-upgrades">\n                <td class="info-header">Upgrades</td>\n                <td class="info-data"></td>\n            </tr>\n        </tbody>\n    </table>\n    <p class="info-text" />\n    <p class="info-maneuvers" />\n</div>')),this.info_container.hide(),this.print_list_button=$(this.container.find("button.print-list")),this.container.find("[rel=tooltip]").tooltip()},i.prototype.setupEventHandlers=function(){return this.container.on("xwing:claimUnique",function(t){return function(i,n,e,s){return t.claimUnique(n,e,s)}}(this)).on("xwing:releaseUnique",function(t){return function(i,n,e,s){return t.releaseUnique(n,e,s)}}(this)).on("xwing:pointsUpdated",function(t){return function(i,n){return null==n&&(n=$.noop),t.onPointsUpdated(n)}}(this)).on("xwing-backend:squadLoadRequested",function(t){return function(i,n){return t.onSquadLoadRequested(n)}}(this)).on("xwing-backend:squadDirtinessChanged",function(t){return function(){return t.onSquadDirtinessChanged()}}(this)).on("xwing-backend:squadNameChanged",function(t){return function(){return t.onSquadNameChanged()}}(this)).on("xwing:beforeLanguageLoad",function(t){return function(i,n){return null==n&&(n=$.noop),t.pretranslation_serialized=t.serialize(),t.removeAllShips(),n()}}(this)).on("xwing:afterLanguageLoad",function(t){return function(i,n,e){var s,a,o,l;for(null==e&&(e=$.noop),t.language=n,t.loadFromSerialized(t.pretranslation_serialized),l=t.ships,a=0,o=l.length;o>a;a++)s=l[a],s.updateSelections();return t.pretranslation_serialized=void 0,e()}}(this)).on("xwing:shipUpdated",function(t){return function(i,n){var e,s,a,o,l;for(null==n&&(n=$.noop),e=!0,l=t.ships,a=0,o=l.length;o>a;a++)s=l[a],s.updateSelections(),""===s.ship_selector.val()&&(e=!1);return e&&!t.suppress_automatic_new_ship?t.addShip():void 0}}(this)),$(window).on("xwing-backend:authenticationChanged",function(t){return function(){return t.resetCurrentSquad()}}(this)).on("xwing-collection:created",function(t){return function(i,n){return t.collection=n,t.collection.onLanguageChange(null,t.language),t.checkCollection(),t.collection_button.removeClass("hidden")}}(this)).on("xwing-collection:changed",function(t){return function(){return t.checkCollection()}}(this)).on("xwing-collection:destroyed",function(t){return function(){return t.collection_button.addClass("hidden")}}(this)).on("xwing:pingActiveBuilder",function(t){return function(i,n){return t.container.is(":visible")?n(t):void 0}}(this)).on("xwing:activateBuilder",function(t){return function(i,n,e){return n===t.faction?(t.tab.tab("show"),e(t)):void 0}}(this)),this.view_list_button.click(function(t){return function(i){return i.preventDefault(),t.showTextListModal()}}(this)),this.print_list_button.click(function(t){return function(i){var n,e,s,a;switch(i.preventDefault(),t.printable_container.find(".printable-header").html(t.list_modal.find(".modal-header").html()),t.printable_container.find(".printable-body").text(""),t.list_display_mode){case"simple":t.printable_container.find(".printable-body").html(t.simple_container.html());break;default:for(a=t.ships,e=0,s=a.length;s>e;e++)n=a[e],null!=n.pilot&&t.printable_container.find(".printable-body").append(n.toHTML());t.printable_container.find(".fancy-ship").toggleClass("tall",t.list_modal.find(".toggle-vertical-space").prop("checked")),t.printable_container.find(".printable-body").toggleClass("bw",t.list_modal.find(".toggle-print-color").prop("checked"))}return""!==$.trim(t.notes.val())&&(t.printable_container.find(".printable-body").append($.trim('<h5 class="print-notes">Notes:</h5>\n<pre class="print-notes"></pre>')),t.printable_container.find(".printable-body pre.print-notes").text(t.notes.val())),window.print()}}(this)),$(window).resize(function(t){return function(){return $(window).width()<768&&"simple"!==t.list_display_mode?t.select_simple_view_button.click():void 0}}(this)),this.notes.change(this.onNotesUpdated),this.notes.on("keyup",this.onNotesUpdated)},i.prototype.onNotesUpdated=function(){return this.total_points>0?(this.current_squad.dirty=!0,this.container.trigger("xwing-backend:squadDirtinessChanged")):void 0},i.prototype.onGameTypeChanged=function(t,i){switch(null==i&&(i=$.noop),t){case"standard":this.isEpic=!1,this.isCustom=!1,this.desired_points_input.val(100),this.maxSmallShipsOfOneType=null,this.maxLargeShipsOfOneType=null;break;case"epic":this.isEpic=!0,this.isCustom=!1,this.maxEpicPointsAllowed=5,this.desired_points_input.val(300),this.maxSmallShipsOfOneType=12,this.maxLargeShipsOfOneType=6;break;case"team-epic":this.isEpic=!0,this.isCustom=!1,this.maxEpicPointsAllowed=3,this.desired_points_input.val(200),this.maxSmallShipsOfOneType=8,this.maxLargeShipsOfOneType=4;break;case"custom":this.isEpic=!1,this.isCustom=!0,this.maxSmallShipsOfOneType=null,this.maxLargeShipsOfOneType=null}return this.max_epic_points_span.text(this.maxEpicPointsAllowed),this.onPointsUpdated(i)},i.prototype.onPointsUpdated=function(t){var i,n,e,a,o,l,r,d,u,c,h,p,f,_,m,g,v,b,y,w,k,x,q,S,C,I,B,z;for(null==t&&(t=$.noop),this.total_points=0,this.total_epic_points=0,f=!1,e=!1,S=this.ships,a=m=0,y=S.length;y>m;a=++m)r=S[a],r.validate(),this.total_points+=r.getPoints(),this.total_epic_points+=r.getEpicPoints(),p=r.checkUnreleasedContent(),p&&(f=p),h=r.checkEpicContent(),h&&(e=h);if(this.total_points_span.text(this.total_points),l=parseInt(this.desired_points_input.val())-this.total_points,this.points_remaining_span.text(l),this.points_remaining_container.toggleClass("red",0>l),this.unreleased_content_used_container.toggleClass("hidden",!f),this.epic_content_used_container.toggleClass("hidden",this.isEpic||!e),this.illegal_epic_upgrades_container.toggleClass("hidden",!0),this.too_many_small_ships_container.toggleClass("hidden",!0),this.too_many_large_ships_container.toggleClass("hidden",!0),this.total_epic_points_container.toggleClass("hidden",!0),this.isEpic){for(this.total_epic_points_container.toggleClass("hidden",!1),this.total_epic_points_span.text(this.total_epic_points),this.total_epic_points_span.toggleClass("red",this.total_epic_points>this.maxEpicPointsAllowed),d={},o=!1,C=this.ships,a=g=0,w=C.length;w>g;a=++g)if(r=C[a],null!=(null!=r?r.data:void 0)&&(null==d[q=r.data.name]&&(d[q]=0),d[r.data.name]+=1,null!=r.data.huge))for(I=r.upgrades,v=0,k=I.length;k>v;v++){if(_=I[v],null!=(null!=_&&null!=(B=_.data)?B.epic_restriction_func:void 0)&&!_.data.epic_restriction_func(r.data,_)){o=!0;break}if(o)break}if(this.illegal_epic_upgrades_container.toggleClass("hidden",!o),null!=this.maxLargeShipsOfOneType&&null!=this.maxSmallShipsOfOneType)for(c in d)n=d[c],u=s.ships[c],null!=u.large&&n>this.maxLargeShipsOfOneType?this.too_many_large_ships_container.toggleClass("hidden",!1):null==r.huge&&n>this.maxSmallShipsOfOneType&&this.too_many_small_ships_container.toggleClass("hidden",!1)}for(this.fancy_total_points_container.text(this.total_points),this.permalink.attr("href",""+window.location.href.split("?")[0]+"?f="+encodeURI(this.faction)+"&d="+encodeURI(this.serialize())),this.fancy_container.text(""),this.simple_container.html('<table class="simple-table"></table>'),i=[],z=this.ships,b=0,x=z.length;x>b;b++)r=z[b],null!=r.pilot&&(this.fancy_container.append(r.toHTML()),this.simple_container.find("table").append(r.toTableRow()),i.push(r.toBBCode()));return this.bbcode_container.find("textarea").val($.trim(""+i.join("\n\n")+"\n\n[b][i]Total: "+this.total_points+"[/i][/b]\n\n[url="+this.permalink.attr("href")+"]View in Yet Another Squad Builder[/url]")),this.checkCollection(),t(this.total_points)
},i.prototype.onSquadLoadRequested=function(t){var i;return this.current_squad=t,this.backend_delete_list_button.removeClass("disabled"),this.squad_name_input.val(this.current_squad.name),this.squad_name_placeholder.text(this.current_squad.name),this.loadFromSerialized(t.serialized),this.notes.val(null!=(i=t.additional_data.notes)?i:""),this.backend_status.fadeOut("slow"),this.current_squad.dirty=!1,this.container.trigger("xwing-backend:squadDirtinessChanged")},i.prototype.onSquadDirtinessChanged=function(){return this.backend_save_list_button.toggleClass("disabled",!(this.current_squad.dirty&&this.total_points>0)),this.backend_save_list_as_button.toggleClass("disabled",0===this.total_points),this.backend_delete_list_button.toggleClass("disabled",null==this.current_squad.id)},i.prototype.onSquadNameChanged=function(){var t;return t=this.current_squad.name.length>n?""+this.current_squad.name.substr(0,n)+"&hellip;":this.current_squad.name,this.squad_name_placeholder.text(""),this.squad_name_placeholder.append(t),this.squad_name_input.val(this.current_squad.name)},i.prototype.removeAllShips=function(){for(;this.ships.length>0;)this.removeShip(this.ships[0]);if(this.ships.length>0)throw new Error("Ships not emptied")},i.prototype.showTextListModal=function(){return this.list_modal.modal("show")},i.prototype.serialize=function(){var t,i,n;return i=3,t=function(){switch(this.game_type_selector.val()){case"standard":return"s";case"epic":return"e";case"team-epic":return"t";case"custom":return"c="+$.trim(this.desired_points_input.val())}}.call(this),"v"+i+"!"+t+"!"+function(){var t,i,e,s;for(e=this.ships,s=[],t=0,i=e.length;i>t;t++)n=e[t],null!=n.pilot&&s.push(n.toSerialized());return s}.call(this).join(";")},i.prototype.loadFromSerialized=function(t){var i,n,e,s,a,o,l,r,d,u,c,h,p,f,_,m,g;if(this.suppress_automatic_new_ship=!0,this.removeAllShips(),s=/^v(\d+)!(.*)/,n=s.exec(t),null!=n)switch(l=parseInt(n[1])){case 3:switch(f=n[2].split("!"),i=f[0],o=f[1],i){case"s":this.game_type_selector.val("standard"),this.game_type_selector.change();break;case"e":this.game_type_selector.val("epic"),this.game_type_selector.change();break;case"t":this.game_type_selector.val("team-epic"),this.game_type_selector.change();break;default:this.game_type_selector.val("custom"),this.desired_points_input.val(parseInt(i.split("=")[1])),this.desired_points_input.change()}for(_=o.split(";"),r=0,c=_.length;c>r;r++)a=_[r],""!==a&&(e=this.addShip(),e.fromSerialized(l,a));break;case 2:for(m=n[2].split(";"),d=0,h=m.length;h>d;d++)a=m[d],""!==a&&(e=this.addShip(),e.fromSerialized(l,a))}else for(g=t.split(";"),u=0,p=g.length;p>u;u++)a=g[u],""!==t&&(e=this.addShip(),e.fromSerialized(1,a));return this.suppress_automatic_new_ship=!1,this.addShip()},i.prototype.uniqueIndex=function(t,i){if(!(i in this.uniques_in_use))throw new Error("Invalid unique type '"+i+"'");return this.uniques_in_use[i].indexOf(t)},i.prototype.claimUnique=function(t,i,n){var e,a,o,l,r,d,u;if(!(this.uniqueIndex(t,i)<0))throw new Error("Unique "+i+" '"+t.name+"' already claimed");if("Pilot"===i){if(e=s.upgradesByLocalizedName[t.name],null!=e&&null!=(null!=e?e.unique:void 0)){if(!(this.uniqueIndex(e,"Upgrade")<0))throw new Error("Unique "+i+" '"+t.name+"' already claimed as crew");this.uniques_in_use.Upgrade.push(e)}}else if("Upgrade"===i){if("Crew"===t.slot&&(a=s.pilotsByLocalizedName[t.name],null!=a&&null!=(null!=a?a.unique:void 0))){if(!(this.uniqueIndex(a,"Pilot")<0))throw new Error("Unique "+i+" '"+t.name+"' already claimed as pilot");this.uniques_in_use.Pilot.push(a)}for(u=null!=(d=t.aka)?d:[],l=0,r=u.length;r>l;l++)o=u[l],this.uniques_in_use.Upgrade.push(s.upgrades[o])}return this.uniques_in_use[i].push(t),n()},i.prototype.releaseUnique=function(t,i,n){var e,a,o,l,r,d,u,c,h;if(o=this.uniqueIndex(t,i),!(o>=0))throw new Error("Unique "+i+" '"+t.name+"' not in use");if(this.uniques_in_use[i].splice(o,1),"Pilot"===i){if(a=s.upgradesByLocalizedName[t.name],null!=a&&null!=(null!=a?a.unique:void 0)){if(o=this.uniqueIndex(a,"Upgrade"),0>o)throw new Error("Unique crew accompanying "+t.name+" was not also claimed!");this.uniques_in_use.Upgrade.splice(o,1)}}else if("Upgrade"===i){if("Crew"===t.slot&&(l=s.pilotsByLocalizedName[t.name],null!=l&&null!=(null!=l?l.unique:void 0))){if(o=this.uniqueIndex(l,"Pilot"),0>o)throw new Error("Unique pilot accompanying "+t.name+" was not also claimed!");this.uniques_in_use.Pilot.splice(o,1)}for(h=null!=(c=t.aka)?c:[],d=0,u=h.length;u>d;d++)r=h[d],e=this.uniqueIndex(s.upgrades[r],"Upgrade"),this.uniques_in_use.Upgrade.splice(e,1)}return n()},i.prototype.addShip=function(){var t;return t=new e({builder:this,container:this.ship_container}),this.ships.push(t),t},i.prototype.removeShip=function(t){var i,n,e;e=__iced_k_noop,i=iced.findDeferral(arguments),function(){return function(e){n=new iced.Deferrals(e,{parent:i,filename:"coffeescripts/xwing.coffee",funcname:"SquadBuilder.removeShip"}),t.destroy(n.defer({lineno:971})),n._fulfill()}}(this)(function(t){return function(){!function(e){n=new iced.Deferrals(e,{parent:i,filename:"coffeescripts/xwing.coffee",funcname:"SquadBuilder.removeShip"}),t.container.trigger("xwing:pointsUpdated",n.defer({lineno:972})),n._fulfill()}(function(){return t.current_squad.dirty=!0,t.container.trigger("xwing-backend:squadDirtinessChanged")})}}(this))},i.prototype.matcher=function(t,i){return t.toUpperCase().indexOf(i.toUpperCase())>=0},i.prototype.getAvailableShipsMatching=function(t){var i,n,e,a,o;null==t&&(t=""),e=[],a=s.ships;for(n in a)i=a[n],o=this.faction,l.call(i.factions,o)>=0&&this.matcher(i.name,t)&&(!i.huge||this.isEpic||this.isCustom)&&e.push({id:i.name,text:i.name,english_name:i.english_name});return e.sort(s.sortHelper)},i.prototype.getAvailablePilotsForShipIncluding=function(t,i,n){var e,a,o,r;return null==n&&(n=""),e=function(){var i,e;i=s.pilotsByLocalizedName,e=[];for(r in i)o=i[r],null!=t&&o.ship!==t||o.faction!==this.faction||!this.matcher(r,n)||e.push(o);return e}.call(this),a=function(){var t;t=[];for(r in e)o=e[r],(null==o.unique||l.call(this.uniques_in_use.Pilot,o)<0)&&t.push(o);return t}.call(this),null!=i&&null!=i.unique&&this.matcher(i.name,n)&&a.push(i),function(){var t,i,n;for(n=[],t=0,i=e.length;i>t;t++)o=e[t],n.push({id:o.id,text:""+o.name+" ("+o.points+")",points:o.points,ship:o.ship,english_name:o.english_name,disabled:l.call(a,o)<0});return n}().sort(s.sortHelper)},i.prototype.getAvailableUpgradesIncluding=function(t,i,n,e,a){var o,r,d,u,c,h,p,f,_,m,g,v,b,y,w;if(null==a&&(a=""),u=function(){var t,i,e,s,a;for(e=n.upgrades,a=[],t=0,i=e.length;i>t;t++)h=e[t],null!=(null!=h&&null!=(s=h.data)?s.limited:void 0)&&a.push(h.data);return a}(),o=function(){var i,e;i=s.upgradesByLocalizedName,e=[];for(p in i)h=i[p],h.slot!==t||!this.matcher(p,a)||null!=h.ship&&h.ship!==n.data.name||null!=h.faction&&h.faction!==this.faction||!this.isEpic&&!this.isCustom&&h.restriction_func===s.hugeOnly||e.push(h);return e}.call(this),r=function(){var t;t=[];for(p in o)h=o[p],(null==h.unique||l.call(this.uniques_in_use.Upgrade,h)<0)&&(null==n||null==h.restriction_func||h.restriction_func(n,e))&&l.call(u,h)<0&&t.push(h);return t}.call(this),"A-Wing Test Pilot"===(null!=n&&null!=(v=n.title)&&null!=(b=v.data)?b.special_case:void 0))for(y=function(){var t,i,e,s;for(e=n.upgrades,s=[],t=0,i=e.length;i>t;t++)h=e[t],null!=(null!=h?h.data:void 0)&&s.push(h.data);return s}(),f=0,m=y.length;m>f;f++)d=y[f],r.removeItem(d);if(null==i||null==i.unique&&null==i.limited||!this.matcher(i.name,a)||r.push(i),c=function(){var t,i,n;for(n=[],t=0,i=o.length;i>t;t++)h=o[t],n.push({id:h.id,text:""+h.name+" ("+h.points+")",points:h.points,english_name:h.english_name,disabled:l.call(r,h)<0});return n}().sort(s.sortHelper),null!=e.adjustment_func){for(w=[],_=0,g=c.length;g>_;_++)h=c[_],w.push(e.adjustment_func(h));return w}return c},i.prototype.getAvailableModificationsIncluding=function(t,i,n){var e,a,o,r,d,u,c,h,p,f;if(null==n&&(n=""),e=function(){var t,e;t=s.modificationsByLocalizedName,e=[];for(d in t)r=t[d],!this.matcher(d,n)||null!=r.ship&&r.ship!==i.data.name||e.push(r);return e}.call(this),a=function(){var t;t=[];for(d in e)r=e[d],!(null==r.unique||l.call(this.uniques_in_use.Modification,r)<0)||null!=r.faction&&r.faction!==this.faction||null!=i&&null!=r.restriction_func&&!r.restriction_func(i)||t.push(r);return t}.call(this),"Royal Guard TIE"===(null!=i&&null!=(h=i.title)&&null!=(p=h.data)?p.special_case:void 0))for(f=function(){var t,n,e,s;for(e=i.modifications,s=[],t=0,n=e.length;n>t;t++)r=e[t],null!=(null!=r?r.data:void 0)&&s.push(r.data);return s}(),u=0,c=f.length;c>u;u++)o=f[u],a.removeItem(o);return null!=t&&null!=t.unique&&this.matcher(t.name,n)&&a.push(t),function(){var t,i,n;for(n=[],t=0,i=e.length;i>t;t++)r=e[t],n.push({id:r.id,text:""+r.name+" ("+r.points+")",points:r.points,english_name:r.english_name,disabled:l.call(a,r)<0});return n}().sort(s.sortHelper)},i.prototype.getAvailableTitlesIncluding=function(t,i,n){var e,a,o,r;return null==n&&(n=""),e=function(){var i,e;i=s.titlesByLocalizedName,e=[];for(r in i)o=i[r],o.ship===t.data.name&&this.matcher(r,n)&&e.push(o);return e}.call(this),a=function(){var i;i=[];for(r in e)o=e[r],!(null==o.unique||l.call(this.uniques_in_use.Title,o)<0)||null!=o.faction&&o.faction!==this.faction||null!=t&&null!=o.restriction_func&&!o.restriction_func(t)||i.push(o);return i}.call(this),null!=i&&null!=i.unique&&this.matcher(i.name,n)&&a.push(i),function(){var t,i,n;for(n=[],t=0,i=e.length;i>t;t++)o=e[t],n.push({id:o.id,text:""+o.name+" ("+o.points+")",points:o.points,english_name:o.english_name,disabled:l.call(a,o)<0});return n}().sort(s.sortHelper)},i.prototype.getManeuverTableHTML=function(t,i){var n,e,s,a,o,l,r,d,u,c,h,p,f,_,m,g,v;if(null==t||0===t.length)return"Missing maneuver info.";for(a="<table><tbody>",l=h=m=t.length-1;0>=m?0>=h:h>=0;l=0>=m?++h:--h){for(e=!1,g=t[l],p=0,_=g.length;_>p;p++)if(c=g[p],c>0){e=!0;break}if(e){for(a+="<tr><td>"+l+"</td>",u=f=0,v=t[l].length;v>=0?v>f:f>v;u=v>=0?++f:--f){if(a+="<td>",t[l][u]>0){if(n=function(){switch(t[l][u]){case 1:return"white";case 2:return"green";case 3:return"red"}}(),a+='<svg xmlns="http://www.w3.org/2000/svg" width="30px" height="30px" viewBox="0 0 200 200">',0===l)a+='<rect x="50" y="50" width="100" height="100" style="fill:'+n+'" />';else{switch(o="black",t[l][u]!==i[l][u]&&(o="gold"),r="",u){case 0:s="M160,180 L160,70 80,70",d="M80,100 V40 L30,70 Z";break;case 1:s="M150,180 S150,120 80,60",d="M80,100 V40 L30,70 Z",r="transform='translate(-5 -15) rotate(45 70 90)' ";break;case 2:s="M100,180 L100,100 100,80",d="M70,80 H130 L100,30 Z";break;case 3:s="M50,180 S50,120 120,60",d="M120,100 V40 L170,70 Z",r="transform='translate(5 -15) rotate(-45 130 90)' ";break;case 4:s="M40,180 L40,70 120,70",d="M120,100 V40 L170,70 Z";break;case 5:s="M50,180 L50,100 C50,10 140,10 140,100 L140,120",d="M170,120 H110 L140,180 Z";break;case 6:s="M150,180 S150,120 80,60",d="M80,100 V40 L30,70 Z",r="transform='translate(0 50)'";break;case 7:s="M50,180 S50,120 120,60",d="M120,100 V40 L170,70 Z",r="transform='translate(0 50)'"}a+=$.trim("<path d='"+d+"' fill='"+n+"' stroke-width='5' stroke='"+o+"' "+r+"/>\n<path stroke-width='25' fill='none' stroke='"+o+"' d='"+s+"' />\n<path stroke-width='15' fill='none' stroke='"+n+"' d='"+s+"' />")}a+="</svg>"}a+="</td>"}a+="</tr>"}}return a+="</tbody></table>"},i.prototype.showTooltip=function(t,i){var n,e,o,r,d,u,c,h,p,f,_,m,g,v,b,y,w,k,x,q,S,C,I,B,z,U,A,P,T,L,D,M,N,E;if(i!==this.tooltip_currently_displaying){switch(t){case"Ship":this.info_container.find(".info-sources").text(function(){var t,n,e,a;for(e=i.pilot.sources,a=[],t=0,n=e.length;n>t;t++)c=e[t],a.push(s.translate(this.language,"sources",c));return a}.call(this).sort().join(", ")),o=i.effectiveStats(),r=$.grep(o.actions,function(t){return l.call(i.data.actions,t)<0}),this.info_container.find(".info-name").html(""+(i.pilot.unique?"&middot;&nbsp;":"")+i.pilot.name+(null!=i.pilot.epic?" ("+s.translate(this.language,"ui","epic")+")":"")+(s.isReleased(i.pilot)?"":" ("+s.translate(this.language,"ui","unreleased")+")")),this.info_container.find("p.info-text").html(null!=(h=i.pilot.text)?h:""),this.info_container.find("tr.info-ship td.info-data").text(i.pilot.ship),this.info_container.find("tr.info-ship").show(),this.info_container.find("tr.info-skill td.info-data").text(a(i.pilot.skill,o,"skill")),this.info_container.find("tr.info-skill").show(),this.info_container.find("tr.info-attack td.info-data").text(a(null!=(p=null!=(q=i.pilot.ship_override)?q.attack:void 0)?p:i.data.attack,o,"attack")),this.info_container.find("tr.info-attack").toggle(null!=(null!=(P=i.pilot.ship_override)?P.attack:void 0)||null!=i.data.attack),this.info_container.find("tr.info-energy td.info-data").text(a(null!=(T=null!=(L=i.pilot.ship_override)?L.energy:void 0)?T:i.data.energy,o,"energy")),this.info_container.find("tr.info-energy").toggle(null!=(null!=(D=i.pilot.ship_override)?D.energy:void 0)||null!=i.data.energy),this.info_container.find("tr.info-range").hide(),this.info_container.find("tr.info-agility td.info-data").text(a(null!=(M=null!=(N=i.pilot.ship_override)?N.agility:void 0)?M:i.data.agility,o,"agility")),this.info_container.find("tr.info-agility").show(),this.info_container.find("tr.info-hull td.info-data").text(a(null!=(E=null!=(f=i.pilot.ship_override)?f.hull:void 0)?E:i.data.hull,o,"hull")),this.info_container.find("tr.info-hull").show(),this.info_container.find("tr.info-shields td.info-data").text(a(null!=(_=null!=(m=i.pilot.ship_override)?m.shields:void 0)?_:i.data.shields,o,"shields")),this.info_container.find("tr.info-shields").show(),this.info_container.find("tr.info-actions td.info-data").html(function(){var t,a,o,l;for(o=i.data.actions.concat(function(){var t,i,n;for(n=[],t=0,i=r.length;i>t;t++)e=r[t],n.push("<strong>"+s.translate(this.language,"action",e)+"</strong>");return n}.call(this)),l=[],t=0,a=o.length;a>t;t++)n=o[t],l.push(s.translate(this.language,"action",n));return l}.call(this).join(", ")),this.info_container.find("tr.info-actions").show(),this.info_container.find("tr.info-upgrades").show(),this.info_container.find("tr.info-upgrades td.info-data").text(function(){var t,n,e,a;for(e=i.pilot.slots,a=[],t=0,n=e.length;n>t;t++)u=e[t],a.push(s.translate(this.language,"slot",u));return a}.call(this).join(", ")||"None"),this.info_container.find("p.info-maneuvers").show(),this.info_container.find("p.info-maneuvers").html(this.getManeuverTableHTML(o.maneuvers,i.data.maneuvers));break;case"Pilot":this.info_container.find(".info-sources").text(function(){var t,n,e,a;for(e=i.sources,a=[],t=0,n=e.length;n>t;t++)c=e[t],a.push(s.translate(this.language,"sources",c));return a}.call(this).sort().join(", ")),this.info_container.find(".info-name").html(""+(i.unique?"&middot;&nbsp;":"")+i.name+(null!=i.epic?" ("+s.translate(this.language,"ui","epic")+")":"")+(s.isReleased(i)?"":" ("+s.translate(this.language,"ui","unreleased")+")")),this.info_container.find("p.info-text").html(null!=(g=i.text)?g:""),d=s.ships[i.ship],this.info_container.find("tr.info-ship td.info-data").text(i.ship),this.info_container.find("tr.info-ship").show(),this.info_container.find("tr.info-skill td.info-data").text(i.skill),this.info_container.find("tr.info-skill").show(),this.info_container.find("tr.info-attack td.info-data").text(null!=(v=null!=(b=i.ship_override)?b.attack:void 0)?v:d.attack),this.info_container.find("tr.info-attack").toggle(null!=(null!=(y=i.ship_override)?y.attack:void 0)||null!=d.attack),this.info_container.find("tr.info-energy td.info-data").text(null!=(w=null!=(k=i.ship_override)?k.energy:void 0)?w:d.energy),this.info_container.find("tr.info-energy").toggle(null!=(null!=(x=i.ship_override)?x.energy:void 0)||null!=d.energy),this.info_container.find("tr.info-range").hide(),this.info_container.find("tr.info-agility td.info-data").text(null!=(S=null!=(C=i.ship_override)?C.agility:void 0)?S:d.agility),this.info_container.find("tr.info-agility").show(),this.info_container.find("tr.info-hull td.info-data").text(null!=(I=null!=(B=i.ship_override)?B.hull:void 0)?I:d.hull),this.info_container.find("tr.info-hull").show(),this.info_container.find("tr.info-shields td.info-data").text(null!=(z=null!=(U=i.ship_override)?U.shields:void 0)?z:d.shields),this.info_container.find("tr.info-shields").show(),this.info_container.find("tr.info-actions td.info-data").text(function(){var t,n,a,o,l,r;for(l=null!=(a=null!=(o=i.ship_override)?o.actions:void 0)?a:s.ships[i.ship].actions,r=[],t=0,n=l.length;n>t;t++)e=l[t],r.push(s.translate(this.language,"action",e));return r}.call(this).join(", ")),this.info_container.find("tr.info-actions").show(),this.info_container.find("tr.info-upgrades").show(),this.info_container.find("tr.info-upgrades td.info-data").text(function(){var t,n,e,a;for(e=i.slots,a=[],t=0,n=e.length;n>t;t++)u=e[t],a.push(s.translate(this.language,"slot",u));return a}.call(this).join(", ")||"None"),this.info_container.find("p.info-maneuvers").show(),this.info_container.find("p.info-maneuvers").html(this.getManeuverTableHTML(d.maneuvers,d.maneuvers));break;case"Addon":this.info_container.find(".info-sources").text(function(){var t,n,e,a;for(e=i.sources,a=[],t=0,n=e.length;n>t;t++)c=e[t],a.push(s.translate(this.language,"sources",c));return a}.call(this).sort().join(", ")),this.info_container.find(".info-name").html(""+(i.unique?"&middot;&nbsp;":"")+i.name+(null!=i.limited?" ("+s.translate(this.language,"ui","limited")+")":"")+(null!=i.epic?" ("+s.translate(this.language,"ui","epic")+")":"")+(s.isReleased(i)?"":" ("+s.translate(this.language,"ui","unreleased")+")")),this.info_container.find("p.info-text").html(null!=(A=i.text)?A:""),this.info_container.find("tr.info-ship").hide(),this.info_container.find("tr.info-skill").hide(),null!=i.energy?(this.info_container.find("tr.info-energy td.info-data").text(i.energy),this.info_container.find("tr.info-energy").show()):this.info_container.find("tr.info-energy").hide(),null!=i.attack?(this.info_container.find("tr.info-attack td.info-data").text(i.attack),this.info_container.find("tr.info-attack").show()):this.info_container.find("tr.info-attack").hide(),null!=i.range?(this.info_container.find("tr.info-range td.info-data").text(i.range),this.info_container.find("tr.info-range").show()):this.info_container.find("tr.info-range").hide(),this.info_container.find("tr.info-agility").hide(),this.info_container.find("tr.info-hull").hide(),this.info_container.find("tr.info-shields").hide(),this.info_container.find("tr.info-actions").hide(),this.info_container.find("tr.info-upgrades").hide(),this.info_container.find("p.info-maneuvers").hide()}return this.info_container.show(),this.tooltip_currently_displaying=i}},i.prototype._randomizerLoopBody=function(i){var n,a,o,l,r,d,u,c,h,p,f,_,m,g,v,b,y,w,k,x,q,S,C,I,B,z,U,A,P,T,L,D,M,N,E,O,R;if(i.keep_running&&i.iterations<i.max_iterations){if(i.iterations++,this.total_points===i.max_points)i.keep_running=!1;else if(this.total_points<i.max_points){for(b=[],T=this.ships,w=0,S=T.length;S>w;w++){for(_=T[w],L=_.upgrades,k=0,C=L.length;C>k;k++)y=L[k],null==y.data&&b.push(y);for(null!=_.title&&null==_.title.data&&b.push(_.title),D=_.modifications,x=0,I=D.length;I>x;x++)c=D[x],null==c.data&&b.push(c)}if(u=$.randomInt(1+b.length),0===u)l=this.getAvailableShipsMatching(),m=l[$.randomInt(l.length)].text,o=this.getAvailablePilotsForShipIncluding(m),p=o[$.randomInt(o.length)],s.pilotsById[p.id].sources.intersects(i.allowed_sources)&&(h=this.addShip(),h.setPilotById(p.id));else switch(n=b[u-1],n.type){case"Upgrade":d=function(){var t,e,a,o;for(a=this.getAvailableUpgradesIncluding(n.slot,null,n.ship),o=[],t=0,e=a.length;e>t;t++)y=a[t],s.upgradesById[y.id].sources.intersects(i.allowed_sources)&&o.push(y);return o}.call(this),d.length>0&&n.setById(d[$.randomInt(d.length)].id);break;case"Title":r=function(){var t,e,a,o;for(a=this.getAvailableTitlesIncluding(n.ship),o=[],t=0,e=a.length;e>t;t++)v=a[t],s.titlesById[v.id].sources.intersects(i.allowed_sources)&&o.push(v);return o}.call(this),r.length>0&&n.setById(r[$.randomInt(r.length)].id);break;case"Modification":a=function(){var t,e,a,o;for(a=this.getAvailableModificationsIncluding(null,n.ship),o=[],t=0,e=a.length;e>t;t++)c=a[t],s.modificationsById[c.id].sources.intersects(i.allowed_sources)&&o.push(c);return o}.call(this),a.length>0&&n.setById(a[$.randomInt(a.length)].id);break;default:throw new Error("Invalid addon type "+n.type)}}else{for(f=[],M=this.ships,q=0,B=M.length;B>q;q++){for(_=M[q],f.push(_),N=_.upgrades,A=0,z=N.length;z>A;A++)y=N[A],null!=y.data&&f.push(y);null!=(null!=(E=_.title)?E.data:void 0)&&f.push(_.title),null!=(null!=(O=_.modification)?O.data:void 0)&&f.push(_.modification)}if(f.length>0)if(g=f[$.randomInt(f.length)],g instanceof e)this.removeShip(g);else{if(!(g instanceof t))throw new Error("Unknown thing to remove "+g);g.setData(null)}}return window.setTimeout(this._makeRandomizerLoopFunc(i),0)}for(window.clearTimeout(i.timer),R=this.ships,P=0,U=R.length;U>P;P++)_=R[P],_.updateSelections();return this.suppress_automatic_new_ship=!1,this.addShip()},i.prototype._makeRandomizerLoopFunc=function(t){return function(i){return function(){return i._randomizerLoopBody(t)}}(this)},i.prototype.randomSquad=function(t,i,n,e){var a,o;for(null==t&&(t=100),null==i&&(i=null),null==n&&(n=1e3),null==e&&(e=1e3),this.backend_status.fadeOut("slow"),this.suppress_automatic_new_ship=!0;this.ships.length>0;)this.removeShip(this.ships[0]);if(this.ships.length>0)throw new Error("Ships not emptied");return a={iterations:0,max_points:t,max_iterations:e,keep_running:!0,allowed_sources:null!=i?i:s.expansions},o=function(){return function(){return a.keep_running=!1}}(this),a.timer=window.setTimeout(o,n),window.setTimeout(this._makeRandomizerLoopFunc(a),0),this.resetCurrentSquad(),this.current_squad.name="Random Squad",this.container.trigger("xwing-backend:squadNameChanged")},i.prototype.setBackend=function(t){return this.backend=t},i.prototype.describeSquad=function(){var t;return function(){var i,n,e,s;for(e=this.ships,s=[],i=0,n=e.length;n>i;i++)t=e[i],null!=t.pilot&&s.push(t.pilot.name);return s}.call(this).join(", ")},i.prototype.listCards=function(){var t,i,n,e,s,a,o,l,r,d,u;for(t={},l=this.ships,e=0,a=l.length;a>e;e++)if(i=l[e],null!=i.pilot){for(t[i.pilot.name]=null,r=i.upgrades,s=0,o=r.length;o>s;s++)n=r[s],null!=n.data&&(t[n.data.name]=null);null!=(null!=(d=i.title)?d.data:void 0)&&(t[i.title.data.name]=null),null!=(null!=(u=i.modification)?u.data:void 0)&&(t[i.modification.data.name]=null)}return Object.keys(t).sort()},i.prototype.getNotes=function(){return this.notes.val()},i.prototype.isSquadPossibleWithCollection=function(){var t,i,n,e,s,a,o,l,r,d,u,c,h,p,f,_,m,g,v,b,y;if(0===Object.keys(null!=(_=null!=(m=this.collection)?m.expansions:void 0)?_:{}).length)return!0;for(this.collection.reset(),r=!0,g=this.ships,d=0,h=g.length;h>d;d++)if(e=g[d],null!=e.pilot){for(s=this.collection.use("ship",e.pilot.english_ship),n=this.collection.use("pilot",e.pilot.english_name),s&&n||(r=!1),v=e.upgrades,u=0,p=v.length;p>u;u++)o=v[u],null!=o.data&&(l=this.collection.use("upgrade",o.data.english_name),l||(r=!1));for(b=e.modifications,c=0,f=b.length;f>c;c++)t=b[c],null!=t.data&&(i=this.collection.use("modification",t.data.english_name),i||(r=!1));null!=(null!=(y=e.title)?y.data:void 0)&&(a=this.collection.use("title",e.title.data.english_name),a||(r=!1))}return r},i.prototype.checkCollection=function(){return null!=this.collection?this.collection_invalid_container.toggleClass("hidden",this.isSquadPossibleWithCollection()):void 0},i.prototype.toXWS=function(){var t,i,n,e,a,o,r,d,u,c,h,p,f,_,m,g,v,b,y,w,k,x,q,S,C;for(c={description:this.getNotes(),faction:s.toXWSFaction[this.faction],name:this.current_squad.name,pilots:[],points:this.total_points,vendor:{yasb:{builder:"(Yet Another) X-Wing Miniatures Squad Builder",builder_url:window.location.href.split("?")[0],link:this.permalink.attr("href")}},version:"0.2.0"},x=this.ships,p=0,g=x.length;g>p;p++)r=x[p],null!=r.pilot&&c.pilots.push(r.toXWS());for(a={},i=0,d=function(){var t,i,n,e;for(n=c.pilots,e=[],t=0,i=n.length;i>t;t++)o=n[t],null!=o.multisection&&e.push(o);return e}(),h=f=0,q=Math.pow(d.length,2);(q>=0?q>f:f>q)&&0!==d.length&&(u=d.shift(),null==u.multisection_id&&(u.multisection_id=i++),null==a[k=u.multisection_id]&&(a[k]=[u]),0!==d.length);h=q>=0?++f:--f){for(e=[],_=0,v=d.length;v>_&&(t=d[_],S=u.name,!(l.call(t.multisection,S)>=0&&(e.push(t),u.multisection.removeItem(t.name),t.multisection.removeItem(u.name),t.multisection_id=u.multisection_id,a[t.multisection_id].push(t),0===u.multisection.length)));_++);for(m=0,b=e.length;b>m;m++)n=e[m],0===n.multisection.length&&d.removeItem(n)}for(C=c.pilots,w=0,y=C.length;y>w;w++)o=C[w],null!=o.multisection&&delete o.multisection;return c},i.prototype.toMinimalXWS=function(){var t,i,n,e;n=this.toXWS();for(t in n)d.call(n,t)&&(i=n[t],"faction"!==t&&"pilots"!==t&&"version"!==t&&delete n[t]);e=n.pilots;for(t in e)d.call(e,t)&&(i=e[t],"name"!==t&&"ship"!==t&&"upgrades"!==t&&"multisection_id"!==t&&delete n[t]);return n},i.prototype.loadFromXWS=function(t,i){var n,e,a,o,l,r,d,u,c,h,p,f,_,m,g,v,b,y,w,k,x,q,S,C,$,I,B,z,U,A,P,T,L,D,M;switch(_=null,r=null,t.version){case"0.2.0":case"0.1.1":if(y=s.fromXWSFaction[t.faction],this.faction!==y)throw new Error("Attempted to load XWS for "+t.faction+" but builder is "+this.faction);for(null!=t.name&&(this.current_squad.name=t.name),null!=t.description&&this.notes.val(t.description),this.suppress_automatic_new_ship=!0,this.removeAllShips(),A=t.pilots,x=0,$=A.length;$>x;x++){h=A[x],c=this.addShip();try{c.setPilot(s.pilotsByFactionCanonicalName[this.faction][h.name])}catch(N){l=N,console.error(l.message);continue}o=[],T=null!=(P=h.upgrades)?P:{};for(b in T)for(v=T[b],q=0,I=v.length;I>q;q++)g=v[q],p=null,w=null!=(L=s.fromXWSUpgrade[b])?L:b.capitalize(),e=function(){switch(w){case"Modification":return s.modificationsByCanonicalName[g];case"Title":return s.titlesByCanonicalName[g];default:return p=w,s.upgradesBySlotCanonicalName[p][g]}}(),null!=e&&o.push({type:w,data:e,slot:p});if(o.length>0){for(k=S=0;1e3>S;k=++S){switch(e=o.shift(),a=!1,e.type){case"Modification":for(D=c.modifications,C=0,B=D.length;B>C;C++)if(u=D[C],null==u.data){u.setData(e.data),a=!0;break}break;case"Title":null==c.title.data&&(e.data instanceof Array?(f=function(){var t,i,e,s;for(s=[],i=0,t=o.length;t>i;i++)n=o[i],("Cannon"===(e=n.data.slot)||"Missile"===e||"Torpedo"===e)&&s.push(n.data.slot);return s}(),c.title.setData(f.length>0?s.titlesByLocalizedName['"Heavy Scyk" Interceptor ('+f[0]+")"]:e.data[0])):c.title.setData(e.data),a=!0);break;default:for(M=c.upgrades,d=U=0,z=M.length;z>U;d=++U)if(m=M[d],m.slot===e.slot&&null==m.data){m.setData(e.data),a=!0;break}}if(a){if(0===o.length)break}else{if(0===o.length){_=!1,r="Could not add "+e.data.name+" to "+c;break}o.push(e)}}if(o.length>0){_=!1,r="Could not add all upgrades";break}}}this.suppress_automatic_new_ship=!1,this.addShip(),_=!0;break;default:_=!1,r="Invalid or unsupported XWS version"}return _&&(this.current_squad.dirty=!0,this.container.trigger("xwing-backend:squadNameChanged"),this.container.trigger("xwing-backend:squadDirtinessChanged")),i({success:_,error:r})},i}(),e=function(){function t(t){this.builder=t.builder,this.container=t.container,this.pilot=null,this.data=null,this.upgrades=[],this.modifications=[],this.title=null,this.setupUI()}return t.prototype.destroy=function(t){var i;if(this.resetPilot(),this.resetAddons(),this.teardownUI(),i=this.builder.ships.indexOf(this),0>i)throw new Error("Ship not registered with builder");return this.builder.ships.splice(i,1),t()},t.prototype.copyFrom=function(t){var i,n,e,s,a,o,r,d,u,c,h,p,f,_,m,g,v,b;if(t===this)throw new Error("Cannot copy from self");if(null!=t.pilot&&null!=t.data&&!t.pilot.unique){for(this.setPilotById(t.pilot.id),e=[],null!=t.title&&t.title.conferredAddons.length>0&&(e=e.concat(t.title.conferredAddons)),null!=(null!=(h=t.modifications[0])?h.data:void 0)&&(e=e.concat(t.modifications[0].conferredAddons)),p=t.upgrades,i=a=0,d=p.length;d>a;i=++a)s=p[i],null!=s.data&&l.call(e,s)<0&&!s.data.unique&&this.upgrades[i].setById(s.data.id);if(null==(null!=(f=t.title)?f.data:void 0)||t.title.data.unique||this.title.setById(t.title.data.id),(null!=(_=t.modifications[0])?_.data:void 0)&&!t.modifications[0].data.unique&&this.modifications[0].setById(t.modifications[0].data.id),null!=t.title&&t.title.conferredAddons.length>0)for(m=t.title.conferredAddons,i=o=0,u=m.length;u>o;i=++o)n=m[i],null==n.data||(null!=(g=n.data)?g.unique:void 0)||this.title.conferredAddons[i].setById(n.data.id);if(null!=t.modifications[0]&&t.modifications[0].conferredAddons.length>0)for(v=t.modifications[0].conferredAddons,i=r=0,c=v.length;c>r;i=++r)n=v[i],null==n.data||(null!=(b=n.data)?b.unique:void 0)||this.modifications[0].conferredAddons[i].setById(n.data.id);return this.updateSelections(),this.builder.container.trigger("xwing:pointsUpdated"),this.builder.current_squad.dirty=!0,this.builder.container.trigger("xwing-backend:squadDirtinessChanged")}},t.prototype.setShipType=function(t){var i,n,e,a,o,l;for(this.pilot_selector.data("select2").container.show(),t!==(null!=(o=this.pilot)?o.ship:void 0)&&this.setPilot(function(){var i,e,a,o;for(a=this.builder.getAvailablePilotsForShipIncluding(t),o=[],i=0,e=a.length;e>i;i++)n=a[i],s.pilotsById[n.id].unique||o.push(s.pilotsById[n.id]);return o}.call(this)[0]),l=this.row.attr("class").split(/\s+/),e=0,a=l.length;a>e;e++)i=l[e],0===i.indexOf("ship-")&&this.row.removeClass(i);return this.remove_button.fadeIn("fast"),this.row.addClass("ship-"+t.toLowerCase().replace(/[^a-z0-9]/gi,"")+"0"),this.builder.container.trigger("xwing:shipUpdated")},t.prototype.setPilotById=function(t){return this.setPilot(s.pilotsById[parseInt(t)])},t.prototype.setPilotByName=function(t){return this.setPilot(s.pilotsByLocalizedName[$.trim(t)])},t.prototype.setPilot=function(t){var i,n,e,a,o,l,r,d,u,c,h,p,f,_,m,g,v,b;if(h=__iced_k_noop,u=iced.findDeferral(arguments),t===this.pilot)return h();if(r=null!=this.pilot&&(null!=t?t.ship:void 0)===this.pilot.ship,l={},a=null,e=[],r){for(v=this.upgrades,p=0,_=v.length;_>p;p++)d=v[p],null!=(null!=d?d.data:void 0)&&(null==l[g=d.slot]&&(l[g]=[]),l[d.slot].push(d));for(null!=this.title&&(a=this.title),b=this.modifications,f=0,m=b.length;m>f;f++)i=b[f],null!=(null!=i?i.data:void 0)&&e.push(i)}this.resetPilot(),this.resetAddons(),function(h){return function(p){return null==t?p(h.copy_button.hide()):(h.data=s.ships[null!=t?t.ship:void 0],void function(i){return null==(null!=t?t.unique:void 0)?i():void!function(i){c=new iced.Deferrals(i,{parent:u,filename:"coffeescripts/xwing.coffee",funcname:"Ship.setPilot"}),h.builder.container.trigger("xwing:claimUnique",[t,"Pilot",c.defer({lineno:1711})]),c._fulfill()}(i)}(function(){var s,u,c,f,_,m,g,v;if(h.pilot=t,null!=h.pilot&&h.setupAddons(),h.copy_button.toggle(!(null!=(_=h.pilot)?_.unique:void 0)),h.setShipType(h.pilot.ship),r){for(null!=(null!=a?a.data:void 0)&&h.title.setById(a.data.id),m=h.modifications,s=0,c=m.length;c>s;s++)i=m[s],n=e.shift(),null!=n&&i.setById(n.data.id);for(g=h.upgrades,u=0,f=g.length;f>u;u++)d=g[u],o=(null!=(v=l[d.slot])?v:[]).shift(),null!=o&&d.setById(o.data.id)}return p()}))}}(this)(function(t){return function(){return t.builder.container.trigger("xwing:pointsUpdated"),h(t.builder.container.trigger("xwing-backend:squadDirtinessChanged"))}}(this))},t.prototype.resetPilot=function(){var t,i,n;n=__iced_k_noop,t=iced.findDeferral(arguments),function(n){return function(e){var s;return null==(null!=(s=n.pilot)?s.unique:void 0)?e():void!function(e){i=new iced.Deferrals(e,{parent:t,filename:"coffeescripts/xwing.coffee",funcname:"Ship.resetPilot"}),n.builder.container.trigger("xwing:releaseUnique",[n.pilot,"Pilot",i.defer({lineno:1735})]),i._fulfill()}(e)}}(this)(function(t){return function(){return t.pilot=null}}(this))},t.prototype.setupAddons=function(){var t,i,n,e,a;for(a=null!=(e=this.pilot.slots)?e:[],i=0,n=a.length;n>i;i++)t=a[i],this.upgrades.push(new s.Upgrade({ship:this,container:this.addon_container,slot:t}));
return this.pilot.ship in s.titlesByShip&&(this.title=new s.Title({ship:this,container:this.addon_container})),this.modifications.push(new s.Modification({ship:this,container:this.addon_container}))},t.prototype.resetAddons=function(){var t,i,n,e,s;s=__iced_k_noop,n=iced.findDeferral(arguments),function(s){return function(a){var o,l,r,d,u,c;for(e=new iced.Deferrals(a,{parent:n,filename:"coffeescripts/xwing.coffee",funcname:"Ship.resetAddons"}),null!=s.title&&s.title.destroy(e.defer({lineno:1757})),u=s.upgrades,o=0,r=u.length;r>o;o++)i=u[o],i.destroy(e.defer({lineno:1759}));for(c=s.modifications,l=0,d=c.length;d>l;l++)t=c[l],null!=t&&t.destroy(e.defer({lineno:1761}));e._fulfill()}}(this)(function(t){return function(){return t.upgrades=[],t.modifications=[],t.title=null}}(this))},t.prototype.getPoints=function(){var t,i,n,e,s,a,o,l,r,d,u,c,h,p;for(i=(null!=(l=null!=(r=this.pilot)?r.points:void 0)?l:0)+(null!=(d=null!=(u=this.title)?u.getPoints():void 0)?d:0),c=this.upgrades,e=0,a=c.length;a>e;e++)n=c[e],i+=n.getPoints();for(h=this.modifications,s=0,o=h.length;o>s;s++)t=h[s],i+=null!=(p=null!=t?t.getPoints():void 0)?p:0;return this.points_container.find("span").text(i),i>0?this.points_container.fadeTo("fast",1):this.points_container.fadeTo(0,0),i},t.prototype.getEpicPoints=function(){var t,i;return null!=(t=null!=(i=this.data)?i.epic_points:void 0)?t:0},t.prototype.updateSelections=function(){var t,i,n,e,s,a,o,l,r;if(null!=this.pilot){for(this.ship_selector.select2("data",{id:this.pilot.ship,text:this.pilot.ship}),this.pilot_selector.select2("data",{id:this.pilot.id,text:""+this.pilot.name+" ("+this.pilot.points+")"}),this.pilot_selector.data("select2").container.show(),o=this.upgrades,n=0,s=o.length;s>n;n++)i=o[n],i.updateSelection();for(null!=this.title&&this.title.updateSelection(),l=this.modifications,r=[],e=0,a=l.length;a>e;e++)t=l[e],r.push(null!=t?t.updateSelection():void 0);return r}return this.pilot_selector.select2("data",null),this.pilot_selector.data("select2").container.toggle(""!==this.ship_selector.val())},t.prototype.setupUI=function(){return this.row=$(document.createElement("DIV")),this.row.addClass("row-fluid ship"),this.row.insertBefore(this.builder.notes_container),this.row.append($.trim('<div class="span3">\n    <input class="ship-selector-container" type="hidden" />\n    <br />\n    <input type="hidden" class="pilot-selector-container" />\n</div>\n<div class="span1 points-display-container">\n    <span></span>\n</div>\n<div class="span6 addon-container" />\n<div class="span2 button-container">\n    <button class="btn btn-danger remove-pilot"><span class="visible-desktop visible-tablet hidden-phone" data-toggle="tooltip" title="Remove Pilot"><i class="icon-remove"></i></span><span class="hidden-desktop hidden-tablet visible-phone">Remove Pilot</span></button>\n    <button class="btn copy-pilot"><span class="visible-desktop visible-tablet hidden-phone" data-toggle="tooltip" title="Clone Pilot"><i class="icon-copy"></i></span><span class="hidden-desktop hidden-tablet visible-phone">Clone Pilot</span></button>\n</div>')),this.row.find(".button-container span").tooltip(),this.ship_selector=$(this.row.find("input.ship-selector-container")),this.pilot_selector=$(this.row.find("input.pilot-selector-container")),this.ship_selector.select2({width:"100%",placeholder:s.translate(this.builder.language,"ui","shipSelectorPlaceholder"),query:function(t){return function(i){return t.builder.checkCollection(),i.callback({more:!1,results:t.builder.getAvailableShipsMatching(i.term)})}}(this),minimumResultsForSearch:$.isMobile()?-1:0,formatResultCssClass:function(t){return function(i){var n;return null!=t.builder.collection?(n=!1,null!=t.pilot&&i.id===s.ships[t.pilot.ship].id?t.builder.collection.checkShelf("ship",i.english_name)||t.builder.collection.checkTable("pilot",i.english_name)||(n=!0):n=!t.builder.collection.checkShelf("ship",i.english_name),n?"select2-result-not-in-collection":""):""}}(this)}),this.ship_selector.on("change",function(t){return function(){return t.setShipType(t.ship_selector.val())}}(this)),this.row.attr("id","row-"+this.ship_selector.data("select2").container.attr("id")),this.pilot_selector.select2({width:"100%",placeholder:s.translate(this.builder.language,"ui","pilotSelectorPlaceholder"),query:function(t){return function(i){return t.builder.checkCollection(),i.callback({more:!1,results:t.builder.getAvailablePilotsForShipIncluding(t.ship_selector.val(),t.pilot,i.term)})}}(this),minimumResultsForSearch:$.isMobile()?-1:0,formatResultCssClass:function(t){return function(i){var n,e;return null!=t.builder.collection?(n=!1,i.id===(null!=(e=t.pilot)?e.id:void 0)?t.builder.collection.checkShelf("pilot",i.english_name)||t.builder.collection.checkTable("pilot",i.english_name)||(n=!0):n=!t.builder.collection.checkShelf("pilot",i.english_name),n?"select2-result-not-in-collection":""):""}}(this)}),this.pilot_selector.on("change",function(t){return function(){return t.setPilotById(t.pilot_selector.select2("val")),t.builder.current_squad.dirty=!0,t.builder.container.trigger("xwing-backend:squadDirtinessChanged"),t.builder.backend_status.fadeOut("slow")}}(this)),this.pilot_selector.data("select2").results.on("mousemove-filtered",function(t){return function(i){var n;return n=$(i.target).closest(".select2-result").data("select2-data"),null!=(null!=n?n.id:void 0)?t.builder.showTooltip("Pilot",s.pilotsById[n.id]):void 0}}(this)),this.pilot_selector.data("select2").container.on("mouseover",function(t){return function(){return null!=t.data?t.builder.showTooltip("Ship",t):void 0}}(this)),this.pilot_selector.data("select2").container.hide(),this.points_container=$(this.row.find(".points-display-container")),this.points_container.fadeTo(0,0),this.addon_container=$(this.row.find("div.addon-container")),this.remove_button=$(this.row.find("button.remove-pilot")),this.remove_button.click(function(t){return function(i){return i.preventDefault(),t.row.slideUp("fast",function(){var i;return t.builder.removeShip(t),null!=(i=t.backend_status)?i.fadeOut("slow"):void 0})}}(this)),this.remove_button.hide(),this.copy_button=$(this.row.find("button.copy-pilot")),this.copy_button.click(function(t){return function(){var i;return i=t.builder.ships[t.builder.ships.length-1],i.copyFrom(t)}}(this)),this.copy_button.hide()},t.prototype.teardownUI=function(){return this.row.text(""),this.row.remove()},t.prototype.toString=function(){return null!=this.pilot?"Pilot "+this.pilot.name+" flying "+this.data.name:"Ship without pilot"},t.prototype.toHTML=function(){var t,i,n,e,s,o,l,r,d,u,c,h,p,f,_,m,g,v,b,y,w,k,x,q,S,C,I,B;for(s=this.effectiveStats(),n=[],_=s.actions,c=0,p=_.length;p>c;c++)t=_[c],n.push(function(){switch(t){case"Focus":return'<i class="xwing-miniatures-font xwing-miniatures-font-focus"></i>';case"Evade":return'<i class="xwing-miniatures-font xwing-miniatures-font-evade"></i>';case"Barrel Roll":return'<i class="xwing-miniatures-font xwing-miniatures-font-barrelroll"></i>';case"Target Lock":return'<i class="xwing-miniatures-font xwing-miniatures-font-targetlock"></i>';case"Boost":return'<i class="xwing-miniatures-font xwing-miniatures-font-boost"></i>';case"Coordinate":return'<i class="xwing-miniatures-font xwing-miniatures-font-coordinate"></i>';case"Jam":return'<i class="xwing-miniatures-font xwing-miniatures-font-jam"></i>';case"Recover":return'<i class="xwing-miniatures-font xwing-miniatures-font-recover"></i>';case"Reinforce":return'<i class="xwing-miniatures-font xwing-miniatures-font-reinforce"></i>';case"Cloak":return'<i class="xwing-miniatures-font xwing-miniatures-font-cloak"></i>';default:return"<span>&nbsp;"+t+"<span>"}}());if(i=n.join(" "),e=null!=(null!=(m=this.pilot.ship_override)?m.attack:void 0)||null!=this.data.attack?$.trim('<i class="xwing-miniatures-font xwing-miniatures-font-attack"></i>\n<span class="info-data info-attack">'+a(null!=(w=null!=(k=this.pilot.ship_override)?k.attack:void 0)?w:this.data.attack,s,"attack")+"</span>"):"",o=null!=(null!=(x=this.pilot.ship_override)?x.energy:void 0)||null!=this.data.energy?$.trim('<i class="xwing-miniatures-font xwing-miniatures-font-energy"></i>\n<span class="info-data info-energy">'+a(null!=(q=null!=(S=this.pilot.ship_override)?S.energy:void 0)?q:this.data.energy,s,"energy")+"</span>"):"",l=$.trim('<div class="fancy-pilot-header">\n    <div class="pilot-header-text">'+this.pilot.name+' <i class="xwing-miniatures-ship xwing-miniatures-ship-'+this.data.canonical_name+'"></i></div>\n    <div class="mask">\n        <div class="outer-circle">\n            <div class="inner-circle pilot-points">'+this.pilot.points+'</div>\n        </div>\n    </div>\n</div>\n<div class="fancy-pilot-stats">\n    <div class="pilot-stats-content">\n        <span class="info-data info-skill">PS '+a(this.pilot.skill,s,"skill")+"</span>\n        "+e+"\n        "+o+'\n        <i class="xwing-miniatures-font xwing-miniatures-font-agility"></i>\n        <span class="info-data info-agility">'+a(null!=(C=null!=(I=this.pilot.ship_override)?I.agility:void 0)?C:this.data.agility,s,"agility")+'</span>\n        <i class="xwing-miniatures-font xwing-miniatures-font-hull"></i>\n        <span class="info-data info-hull">'+a(null!=(B=null!=(g=this.pilot.ship_override)?g.hull:void 0)?B:this.data.hull,s,"hull")+'</span>\n        <i class="xwing-miniatures-font xwing-miniatures-font-shield"></i>\n        <span class="info-data info-shields">'+a(null!=(v=null!=(b=this.pilot.ship_override)?b.shields:void 0)?v:this.data.shields,s,"shields")+"</span>\n        &nbsp;\n        "+i+"\n    </div>\n</div>"),this.pilot.text&&(l+=$.trim('<div class="fancy-pilot-text">'+this.pilot.text+"</div>")),d=function(){var t,i,n,e;for(n=this.upgrades,e=[],t=0,i=n.length;i>t;t++)u=n[t],null!=u.data&&e.push(u);return e}.call(this).concat(function(){var t,i,n,e;for(n=this.modifications,e=[],t=0,i=n.length;i>t;t++)r=n[t],null!=r.data&&e.push(r);return e}.call(this)),null!=(null!=(y=this.title)?y.data:void 0)&&d.push(this.title),d.length>0){for(l+=$.trim('<div class="fancy-upgrade-container">'),h=0,f=d.length;f>h;h++)u=d[h],l+=u.toHTML();l+=$.trim("</div>")}return'<div class="fancy-ship">'+l+"</div>"},t.prototype.toTableRow=function(){var t,i,n,e,s,a,o;if(n=$.trim('<tr class="simple-pilot">\n    <td class="name">'+this.pilot.name+" &mdash; "+this.data.name+'</td>\n    <td class="points">'+this.pilot.points+"</td>\n</tr>"),i=function(){var t,i,n,s;for(n=this.upgrades,s=[],t=0,i=n.length;i>t;t++)e=n[t],null!=e.data&&s.push(e);return s}.call(this).concat(function(){var i,n,e,s;for(e=this.modifications,s=[],i=0,n=e.length;n>i;i++)t=e[i],null!=t.data&&s.push(t);return s}.call(this)),null!=(null!=(o=this.title)?o.data:void 0)&&i.push(this.title),i.length>0)for(s=0,a=i.length;a>s;s++)e=i[s],n+=e.toTableRow();return n+="<tr><td>&nbsp;</td><td></td></tr>"},t.prototype.toBBCode=function(){var t,i,n,e,s,a,o,l,r;if(t="[b]"+this.pilot.name+" ("+this.pilot.points+")[/b]",e=function(){var t,i,n,e;for(n=this.upgrades,e=[],t=0,i=n.length;i>t;t++)s=n[t],null!=s.data&&e.push(s);return e}.call(this).concat(function(){var t,i,e,s;for(e=this.modifications,s=[],t=0,i=e.length;i>t;t++)n=e[t],null!=n.data&&s.push(n);return s}.call(this)),null!=(null!=(r=this.title)?r.data:void 0)&&e.push(this.title),e.length>0){for(t+="\n",i=[],o=0,l=e.length;l>o;o++)s=e[o],a=s.toBBCode(),null!=a&&i.push(a);t+=i.join("\n")}return t},t.prototype.toSerialized=function(){var t,i,n,e,s,a,o,r,d,u,c,h,p,f,_,m,g,v,b,y,w;for(i=null!=(h=null!=(p=this.title)?p.conferredAddons:void 0)?h:[],f=this.modifications,r=0,u=f.length;u>r;r++)e=f[r],i=i.concat(null!=(_=null!=e?e.conferredAddons:void 0)?_:[]);for(o=""+function(){var t,e,s,o,r,d;for(s=this.upgrades,d=[],n=t=0,e=s.length;e>t;n=++t)a=s[n],l.call(i,a)<0&&d.push(null!=(o=null!=a&&null!=(r=a.data)?r.id:void 0)?o:-1);return d}.call(this),s=[],d=0,c=i.length;c>d;d++)t=i[d],s.push(t.toSerialized());return[this.pilot.id,o,null!=(m=null!=(g=this.title)&&null!=(v=g.data)?v.id:void 0)?m:-1,null!=(b=null!=(y=this.modifications[0])&&null!=(w=y.data)?w.id:void 0)?b:-1,s.join(",")].join(":")},t.prototype.fromSerialized=function(t,n){var e,s,a,o,l,r,d,u,c,h,p,f,_,m,g,v,b,y,w,k,x,q,S,C,$,I,B,z,U,A,P,T,L,D,M,N;switch(t){case 1:for(U=n.split(":"),p=U[0],v=U[1],m=U[2],_=U[3],h=U[4],this.setPilotById(parseInt(p)),A=v.split(","),d=b=0,x=A.length;x>b;d=++b)g=A[d],g=parseInt(g),g>=0&&this.upgrades[d].setById(g);if(m=parseInt(m),m>=0&&this.title.setById(m),null!=this.title&&this.title.conferredAddons.length>0)for(P=_.split(","),d=y=0,q=P.length;q>y;d=++y)g=P[d],g=parseInt(g),g>=0&&this.title.conferredAddons[d].setById(g);h=parseInt(h),h>=0&&this.modifications[0].setById(h);break;case 2:case 3:for(T=n.split(":"),p=T[0],v=T[1],m=T[2],h=T[3],r=T[4],this.setPilotById(parseInt(p)),L=v.split(","),d=w=0,S=L.length;S>w;d=++w)g=L[d],g=parseInt(g),g>=0&&this.upgrades[d].setById(g);if(m=parseInt(m),m>=0&&this.title.setById(m),h=parseInt(h),h>=0&&this.modifications[0].setById(h),r=null!=r?r.split(","):[],null!=this.title&&this.title.conferredAddons.length>0)for(f=r.splice(0,this.title.conferredAddons.length),d=k=0,C=f.length;C>k;d=++k){if(l=f[d],D=l.split("."),a=D[0],s=D[1],s=parseInt(s),e=i[a],o=this.title.conferredAddons[d],!(o instanceof e))throw new Error("Expected addon class "+e.constructor.name+" for conferred addon at index "+d+" but "+o.constructor.name+" is there");o.setById(s)}for(M=this.modifications,B=0,$=M.length;$>B;B++)if(u=M[B],null!=(null!=u?u.data:void 0)&&u.conferredAddons.length>0)for(c=r.splice(0,u.conferredAddons.length),d=z=0,I=c.length;I>z;d=++z){if(l=c[d],N=l.split("."),a=N[0],s=N[1],s=parseInt(s),e=i[a],o=u.conferredAddons[d],!(o instanceof e))throw new Error("Expected addon class "+e.constructor.name+" for conferred addon at index "+d+" but "+o.constructor.name+" is there");o.setById(s)}}return this.updateSelections()},t.prototype.effectiveStats=function(){var t,i,n,e,s,a,o,l,r,d,u,c,h,p,f,_,m,g,v,b,y,w,k,x,q,S,C,$,I,B;for(n={skill:this.pilot.skill,attack:null!=(d=null!=(u=this.pilot.ship_override)?u.attack:void 0)?d:this.data.attack,energy:null!=(w=null!=(x=this.pilot.ship_override)?x.energy:void 0)?w:this.data.energy,agility:null!=(q=null!=(S=this.pilot.ship_override)?S.agility:void 0)?q:this.data.agility,hull:null!=(C=null!=($=this.pilot.ship_override)?$.hull:void 0)?C:this.data.hull,shields:null!=(I=null!=(B=this.pilot.ship_override)?B.shields:void 0)?I:this.data.shields,actions:(null!=(c=null!=(h=this.pilot.ship_override)?h.actions:void 0)?c:this.data.actions).slice(0)},n.maneuvers=[],i=s=0,p=(null!=(f=this.data.maneuvers)?f:[]).length;p>=0?p>s:s>p;i=p>=0?++s:--s)n.maneuvers[i]=this.data.maneuvers[i].slice(0);for(_=this.upgrades,a=0,l=_.length;l>a;a++)e=_[a],null!=(null!=e&&null!=(m=e.data)?m.modifier_func:void 0)&&e.data.modifier_func(n);for(null!=(null!=(g=this.title)&&null!=(v=g.data)?v.modifier_func:void 0)&&this.title.data.modifier_func(n),b=this.modifications,o=0,r=b.length;r>o;o++)t=b[o],null!=(null!=t&&null!=(y=t.data)?y.modifier_func:void 0)&&t.data.modifier_func(n);return null!=(null!=(k=this.pilot)?k.modifier_func:void 0)&&this.pilot.modifier_func(n),n},t.prototype.validate=function(){var t,i,n,e,s,a,o,l,r,d,u,c,h,p,f,_,m,g,v,b,y,w,k,x,q,S,C;for(n=128,i=o=0;n>=0?n>o:o>n;i=n>=0?++o:--o){for(a=!0,c=this.upgrades,l=0,d=c.length;d>l;l++)if(s=c[l],t=null!=(h=null!=(b=null!=s&&null!=(y=s.data)?y.validation_func:void 0)?b:null!=s&&null!=(w=s.data)?w.restriction_func:void 0)?h:void 0,null!=t&&!t(this,s)){s.setById(null),a=!1;break}if(t=null!=(k=null!=(x=null!=(q=this.title)&&null!=(S=q.data)?S.validation_func:void 0)?x:null!=(C=this.title)&&null!=(p=C.data)?p.restriction_func:void 0)?k:void 0,null==t||t(this)){for(f=this.modifications,r=0,u=f.length;u>r;r++)if(e=f[r],t=null!=(_=null!=(m=null!=e&&null!=(g=e.data)?g.validation_func:void 0)?m:null!=e&&null!=(v=e.data)?v.restriction_func:void 0)?_:void 0,null!=t&&!t(this,e)){e.setById(null),a=!1;break}if(a)break}else this.title.setById(null)}return this.updateSelections()},t.prototype.checkUnreleasedContent=function(){var t,i,n,e,a,o,l,r,d;if(null!=this.pilot&&!s.isReleased(this.pilot))return!0;if(null!=(null!=(l=this.title)?l.data:void 0)&&!s.isReleased(this.title.data))return!0;for(r=this.modifications,n=0,a=r.length;a>n;n++)if(t=r[n],null!=(null!=t?t.data:void 0)&&!s.isReleased(t.data))return!0;for(d=this.upgrades,e=0,o=d.length;o>e;e++)if(i=d[e],null!=(null!=i?i.data:void 0)&&!s.isReleased(i.data))return!0;return!1},t.prototype.checkEpicContent=function(){var t,i,n,e,s,a,o,l,r,d,u,c;if(null!=this.pilot&&null!=this.pilot.epic)return!0;if(null!=(null!=(o=this.title)&&null!=(l=o.data)?l.epic:void 0))return!0;for(r=this.modifications,n=0,s=r.length;s>n;n++)if(t=r[n],null!=(null!=t&&null!=(d=t.data)?d.epic:void 0))return!0;for(u=this.upgrades,e=0,a=u.length;a>e;e++)if(i=u[e],null!=(null!=i&&null!=(c=i.data)?c.epic:void 0))return!0;return!1},t.prototype.toXWS=function(){var t,i,n,e,s,a,o,l,r,d,u;for(e={name:this.pilot.canonical_name,points:this.getPoints(),ship:this.data.canonical_name},this.data.multisection&&(e.multisection=this.data.multisection.slice(0)),n={},r=this.upgrades,s=0,o=r.length;o>s;s++)i=r[s],null!=(null!=i?i.data:void 0)&&i.toXWS(n);for(d=this.modifications,a=0,l=d.length;l>a;a++)t=d[a],null!=(null!=t?t.data:void 0)&&t.toXWS(n);return null!=(null!=(u=this.title)?u.data:void 0)&&this.title.toXWS(n),Object.keys(n).length>0&&(e.upgrades=n),e},t}(),t=function(){function t(t){this.ship=t.ship,this.container=$(t.container),this.data=null,this.unadjusted_data=null,this.conferredAddons=[],this.serialization_code="X",this.type=null,this.dataByName=null,this.dataById=null}return t.prototype.destroy=function(){var t,i,n,e,s;s=__iced_k_noop,n=iced.findDeferral(arguments),i=arguments[0],t=2<=arguments.length?o.call(arguments,1):[],function(t){return function(i){var s;return null==(null!=(s=t.data)?s.unique:void 0)?i():void!function(i){e=new iced.Deferrals(i,{parent:n,filename:"coffeescripts/xwing.coffee",funcname:"GenericAddon.destroy"}),t.ship.builder.container.trigger("xwing:releaseUnique",[t.data,t.type,e.defer({lineno:2274})]),e._fulfill()}(i)}}(this)(function(n){return function(){return n.selector.select2("destroy"),i(t)}}(this))},t.prototype.setupSelector=function(t){return this.selector=$(document.createElement("INPUT")),this.selector.attr("type","hidden"),this.container.append(this.selector),$.isMobile()&&(t.minimumResultsForSearch=-1),t.formatResultCssClass=function(t){return function(i){var n,e;return null!=t.ship.builder.collection?(n=!1,i.id===(null!=(e=t.data)?e.id:void 0)?t.ship.builder.collection.checkShelf(t.type.toLowerCase(),i.english_name)||t.ship.builder.collection.checkTable(t.type.toLowerCase(),i.english_name)||(n=!0):n=!t.ship.builder.collection.checkShelf(t.type.toLowerCase(),i.english_name),n?"select2-result-not-in-collection":""):""}}(this),this.selector.select2(t),this.selector.on("change",function(t){return function(){return t.setById(t.selector.select2("val")),t.ship.builder.current_squad.dirty=!0,t.ship.builder.container.trigger("xwing-backend:squadDirtinessChanged"),t.ship.builder.backend_status.fadeOut("slow")}}(this)),this.selector.data("select2").results.on("mousemove-filtered",function(t){return function(i){var n;return n=$(i.target).closest(".select2-result").data("select2-data"),null!=(null!=n?n.id:void 0)?t.ship.builder.showTooltip("Addon",t.dataById[n.id]):void 0}}(this)),this.selector.data("select2").container.on("mouseover",function(t){return function(){return null!=t.data?t.ship.builder.showTooltip("Addon",t.data):void 0}}(this))},t.prototype.setById=function(t){return this.setData(this.dataById[parseInt(t)])},t.prototype.setByName=function(t){return this.setData(this.dataByName[$.trim(t)])},t.prototype.setData=function(t){var i,n,e,s;return e=__iced_k_noop,i=iced.findDeferral(arguments),(null!=t?t.id:void 0)===(null!=(s=this.data)?s.id:void 0)?e():void!function(t){return function(e){var s;return null==(null!=(s=t.data)?s.unique:void 0)?e():void!function(e){n=new iced.Deferrals(e,{parent:i,filename:"coffeescripts/xwing.coffee",funcname:"GenericAddon.setData"}),t.ship.builder.container.trigger("xwing:releaseUnique",[t.unadjusted_data,t.type,n.defer({lineno:2320})]),n._fulfill()}(e)}}(this)(function(s){return function(){s.rescindAddons(),function(e){return null==(null!=t?t.unique:void 0)?e():void!function(e){n=new iced.Deferrals(e,{parent:i,filename:"coffeescripts/xwing.coffee",funcname:"GenericAddon.setData"}),s.ship.builder.container.trigger("xwing:claimUnique",[t,s.type,n.defer({lineno:2323})]),n._fulfill()}(e)}(function(){return s.data=s.unadjusted_data=t,null!=s.data&&(null!=s.adjustment_func&&(s.data=s.adjustment_func(s.data)),s.conferAddons()),e(s.ship.builder.container.trigger("xwing:pointsUpdated"))})}}(this))},t.prototype.conferAddons=function(){var t,i,n,e,a,o,l;if(null!=this.data.confersAddons&&this.data.confersAddons.length>0){for(o=this.data.confersAddons,l=[],e=0,a=o.length;a>e;e++){if(t=o[e],n=t.type,i={ship:this.ship,container:this.container},null!=t.slot&&(i.slot=t.slot),null!=t.adjustment_func&&(i.adjustment_func=t.adjustment_func),t=new n(i),t instanceof s.Upgrade)this.ship.upgrades.push(t);else{if(!(t instanceof s.Modification))throw new Error("Unexpected addon type for addon "+t);this.ship.modifications.push(t)}l.push(this.conferredAddons.push(t))}return l}},t.prototype.rescindAddons=function(){var t,i,n,e;e=__iced_k_noop,i=iced.findDeferral(arguments),function(e){return function(s){var a,o,l;for(n=new iced.Deferrals(s,{parent:i,filename:"coffeescripts/xwing.coffee",funcname:"GenericAddon.rescindAddons"}),l=e.conferredAddons,a=0,o=l.length;o>a;a++)t=l[a],t.destroy(n.defer({lineno:2355}));n._fulfill()}}(this)(function(i){return function(){var n,e,a;for(a=i.conferredAddons,n=0,e=a.length;e>n;n++)if(t=a[n],t instanceof s.Upgrade)i.ship.upgrades.removeItem(t);else{if(!(t instanceof s.Modification))throw new Error("Unexpected addon type for addon "+t);i.ship.modifications.removeItem(t)}return i.conferredAddons=[]}}(this))},t.prototype.getPoints=function(){var t,i;return null!=(t=null!=(i=this.data)?i.points:void 0)?t:0},t.prototype.updateSelection=function(){return null!=this.data?this.selector.select2("data",{id:this.data.id,text:""+this.data.name+" ("+this.data.points+")"}):this.selector.select2("data",null)},t.prototype.toString=function(){return null!=this.data?""+this.data.name+" ("+this.data.points+")":"No "+this.type},t.prototype.toHTML=function(){var t,i,n;return null!=this.data?(i=(null!=(n=this.data.slot)?n:this.type).toLowerCase().replace(/[^0-9a-z]/gi,""),t=null!=this.data.attack?$.trim('<div class="upgrade-attack">\n    <span class="upgrade-attack-range">'+this.data.range+'</span>\n    <span class="info-data info-attack">'+this.data.attack+'</span>\n    <i class="xwing-miniatures-font xwing-miniatures-font-attack"></i>\n</div>'):"",$.trim('<div class="upgrade-container">\n    <div class="upgrade-stats">\n        <div class="upgrade-name"><i class="xwing-miniatures-font xwing-miniatures-font-'+i+'"></i> '+this.data.name+'</div>\n        <div class="mask">\n            <div class="outer-circle">\n                <div class="inner-circle upgrade-points">'+this.data.points+"</div>\n            </div>\n        </div>\n        "+t+'\n    </div>\n    <div class="upgrade-text">'+this.data.text+'</div>\n    <div style="clear: both;"></div>\n</div>')):""},t.prototype.toTableRow=function(){return null!=this.data?$.trim('<tr class="simple-addon">\n    <td class="name">'+this.data.name+'</td>\n    <td class="points">'+this.data.points+"</td>\n</tr>"):""},t.prototype.toBBCode=function(){return null!=this.data?"[i]"+this.data.name+" ("+this.data.points+")[/i]":null},t.prototype.toSerialized=function(){var t,i;return""+this.serialization_code+"."+(null!=(t=null!=(i=this.data)?i.id:void 0)?t:-1)},t.prototype.toXWS=function(t){var i;return i=function(){var t,i;switch(this.type){case"Upgrade":return null!=(t=s.toXWSUpgrade[this.slot])?t:this.slot.canonicalize();default:return null!=(i=s.toXWSUpgrade[this.type])?i:this.type.canonicalize()}}.call(this),(null!=t[i]?t[i]:t[i]=[]).push(this.data.canonical_name)},t}(),s.Upgrade=function(t){function i(t){i.__super__.constructor.call(this,t),this.slot=t.slot,this.type="Upgrade",this.dataById=s.upgradesById,this.dataByName=s.upgradesByLocalizedName,this.serialization_code="U",null!=t.adjustment_func&&(this.adjustment_func=t.adjustment_func),this.setupSelector()}return u(i,t),i.prototype.setupSelector=function(){return i.__super__.setupSelector.call(this,{width:"50%",placeholder:s.translate(this.ship.builder.language,"ui","upgradePlaceholder",this.slot),allowClear:!0,query:function(t){return function(i){return t.ship.builder.checkCollection(),i.callback({more:!1,results:t.ship.builder.getAvailableUpgradesIncluding(t.slot,t.data,t.ship,t,i.term)})}}(this)})},i}(t),s.Modification=function(t){function i(t){i.__super__.constructor.call(this,t),this.type="Modification",this.dataById=s.modificationsById,this.dataByName=s.modificationsByLocalizedName,this.serialization_code="M",this.setupSelector()}return u(i,t),i.prototype.setupSelector=function(){return i.__super__.setupSelector.call(this,{width:"50%",placeholder:s.translate(this.ship.builder.language,"ui","modificationPlaceholder"),allowClear:!0,query:function(t){return function(i){return t.ship.builder.checkCollection(),i.callback({more:!1,results:t.ship.builder.getAvailableModificationsIncluding(t.data,t.ship,i.term)})}}(this)})},i}(t),s.Title=function(t){function i(t){i.__super__.constructor.call(this,t),this.type="Title",this.dataById=s.titlesById,this.dataByName=s.titlesByLocalizedName,this.serialization_code="T",this.setupSelector()}return u(i,t),i.prototype.setupSelector=function(){return i.__super__.setupSelector.call(this,{width:"50%",placeholder:s.translate(this.ship.builder.language,"ui","titlePlaceholder"),allowClear:!0,query:function(t){return function(i){return t.ship.builder.checkCollection(),i.callback({more:!1,results:t.ship.builder.getAvailableTitlesIncluding(t.ship,t.data,i.term)})}}(this)})},i}(t),i={M:s.Modification,T:s.Title,U:s.Upgrade}}).call(this);
//# sourceMappingURL=xwing.min.js
//@ sourceMappingURL=xwing.min.map